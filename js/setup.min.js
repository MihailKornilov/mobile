var AJAX_SETUP=SITE+"/ajax/setup.php?"+VALUES;
$(document).on("click","#setup_info #devs div",function(){function a(a,c){$("#devs span").remove();b.prepend("<span><em"+(c?' class="err"':"")+">"+a+"</em></span>").find("span").delay(1500).fadeOut(1500,function(){$(this).remove()})}for(var b=$(this),c=b.parent().find("input"),d=[],e=0;e<c.length;e++){var g=c.eq(e);1==g.val()&&d.push(g.attr("id"))}0==d.length?a("Не сохранено!<br />Необходимо выбрать<br />минимум одну категорию",!0):(c={op:"info_devs_set",devs:d.join()},$.post(AJAX_SETUP,c,function(b){b.success&&
a("Изменения сохранены")},"json"))}).on("click","#setup_worker .add",function(){function a(){if(!e.hasClass("busy")){d=0;$(".res").remove();var b={user_ids:$.trim($("#viewer_id").val()),fields:"photo_50",v:5.2};b.user_ids&&(/vk.com/.test(b.user_ids)&&(b.user_ids=b.user_ids.split("vk.com/")[1]),/\?/.test(b.user_ids)&&(b.user_ids=b.user_ids.split("?")[0]),/#/.test(b.user_ids)&&(b.user_ids=b.user_ids.split("#")[0]),e.addClass("busy"),VK.api("users.get",b,function(b){e.removeClass("busy");b.response&&
(b=b.response[0],e.after('<table class="res"><tr><td class="photo"><img src='+b.photo_50+'><td class="name">'+b.first_name+" "+b.last_name+"</table>"),d=b.id)}))}}function b(b,a){c.bottom.vkHint({msg:'<SPAN class="red">'+b+"</SPAN>",remove:1,indent:40,show:1,top:a,left:90})}var c=_dialog({top:50,width:350,head:"Добавление нового сотрудника",content:'<div id="setup_worker_add"><h1>Укажите адрес страницы пользователя или его<br />ID ВКонтакте:</h1><h2>Формат адреса может быть следующих видов:<br /><u>http://vk.com/id12345</u>, <u>http://vk.com/durov</u>.<br />Либо используйте ID пользователя: <u>id12345</u>, <u>durov</u>, <u>12345</u>.</h2><input type="text" id="viewer_id" /><div class="vkButton"><button>Найти</button></div><a class="manual">Или заполните данные вручную..</a><table class="manual_tab"><tr><td class="label">Имя:<td><input type="text" id="first_name" /><tr><td class="label">Фамилия:<td><input type="text" id="last_name" /><tr><td class="label">Пол:<td><input type="hidden" id="sex" /></table></div>',
butSubmit:"Добавить",submit:function(){var a={op:"worker_add",viewer_id:d,first_name:$("#first_name").val(),last_name:$("#last_name").val(),sex:$("#sex").val()};a.viewer_id||a.first_name||a.last_name?a.first_name&&a.last_name&&0==a.sex?b("Не указан пол",-47):(c.process(),$.post(AJAX_SETUP,a,function(a){a.success?(c.close(),_msg("Новый сотрудник успешно добавлен."),$("#spisok").html(a.html)):(c.abort(),b(a.text,-60))},"json")):b("Произведите поиск пользователя<br>или укажите вручную имя и фамилию",
-60)}}),d=0,e=$("#viewer_id").focus().keyEnter(a).next();e.click(a);$(".manual").click(function(){$(this).hide().next().show();$(".res").remove();d=0;$("#viewer_id").val("");$("#first_name").focus()});$("#sex")._radio({spisok:[{uid:2,title:"М"},{uid:1,title:"Ж"}]})}).on("click","#setup_worker .img_del",function(){for(var a=$(this);!a.hasClass("unit");)a=a.parent();var b=_dialog({top:110,width:250,head:"Удаление сотрудника",content:"<center>Подтвердите удаление сотрудника.</center>",butSubmit:"Удалить",
submit:function(){var c={op:"worker_del",viewer_id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?(b.close(),_msg("Сотрудник удален."),$("#spisok").html(a.html)):b.abort()},"json")}})}).on("click","#setup_invoice .add",function(){function a(){var a={op:"invoice_add",name:$("#name").val(),about:$("#about").val(),types:$("#types").val()};a.name?(c.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),c.close(),_msg("Внесено!")):(c.abort(),b(a.text))},"json")):
(b("Не указано наименование"),$("#name").focus())}function b(b){c.bottom.vkHint({msg:"<SPAN class=red>"+b+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}$(this);var c=_dialog({width:400,head:"Добавление нового счёта",content:'<table class="setup-tab"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="50" /><tr><td class="label topi">Описание:<td><textarea id="about"></textarea><tr><td class="label topi">Виды платежей:<td><input type="hidden" id="types" /></table>',
submit:a});$("#name").focus().keyEnter(a);$("#types")._select({width:218,multiselect:1,spisok:INCOME_SPISOK})}).on("click","#setup_invoice .img_edit",function(){function a(){var a={op:"invoice_edit",id:d,name:$("#name").val(),about:$("#about").val(),types:$("#types").val()};a.name?(f.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),f.close(),_msg("Сохранено!")):(f.abort(),b(a.text))},"json")):(b("Не указано наименование"),$("#name").focus())}function b(b){f.bottom.vkHint({msg:"<SPAN class=red>"+
b+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}for(var c=$(this);"TR"!=c[0].tagName;)c=c.parent();var d=c.attr("val"),e=c.find(".name div").html(),g=c.find(".name pre").html(),c=c.find(".type_id").val(),f=_dialog({width:400,head:"Редактирование данных счёта",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" value="'+e+'" /><tr><td class="label r top">Описание:<td><textarea id="about">'+g+'</textarea><tr><td class="label topi">Виды платежей:<td><input type="hidden" id="types" value="'+
c+'" /></table>',butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a);$("#types")._select({width:218,multiselect:1,spisok:INCOME_SPISOK})}).on("click","#setup_invoice .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление счёта",content:"<center><b>Подтвердите удаление счёта.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=a[0].tagName;)a=a.parent();var c={op:"setup_invoice_del",id:a.attr("val")};b.process();$.post(AJAX_MAIN,c,function(a){a.success?
($(".spisok").html(a.html),b.close(),_msg("Удалено!")):b.abort()},"json")}})}).on("click","#setup_income .add",function(){function a(){var a={op:"income_add",name:$("#name").val()};a.name?(b.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено!"),sortable()):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({head:"Добавление нового вида платежа",
content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" /></table>',submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_income .img_edit",function(){function a(){var a={op:"income_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено!"),sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",
top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"DD"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),b='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" value="'+b.find(".name").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование вида платежа",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_income .img_del",function(){var a=$(this),b=_dialog({top:90,
width:300,head:"Удаление вида платежа",content:"<center><b>Подтвердите удаление вида платежа.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=a[0].tagName;)a=a.parent();var c={op:"income_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено!"),sortable()):b.abort()},"json")}})}).on("click","#setup_expense .add",function(){function a(){var a={op:"expense_add",name:$("#name").val(),show_worker:$("#show_worker").val()};
a.name?(b.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#spisok").html(a.html),b.close(),_msg("Внесено!"),sortable()):b.abort()},"json")):(b.bottom.vkHint({msg:"<span class=red>Не указано наименование</span>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({width:400,head:"Добавление новой категории расхода мастерской",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" /><tr><td class="label r">Список сотрудников:<td><input id="show_worker" type="hidden" /></table>',
submit:a});$("#name").focus().keyEnter(a);$("#show_worker")._check()}).on("click","#setup_expense .img_edit",function(){function a(){var a={op:"expense_edit",id:c,name:$("#name").val(),show_worker:$("#show_worker").val()};a.name?(e.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#spisok").html(a.html),e.close(),_msg("Сохранено!"),sortable()):e.abort()},"json")):(e.bottom.vkHint({msg:'<span class="red">Не указано наименование</span>',top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}
for(var b=$(this);"DD"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),d=b.find(".name").html(),b=b.find(".worker").html()?1:0,e=_dialog({width:400,head:"Редактирование категории расхода мастерской",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="50" value="'+d+'" /><tr><td class="label r">Список сотрудников:<td><input id="show_worker" type="hidden" value="'+b+'" /></table>',butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a);
$("#show_worker")._check()}).on("click","#setup_expense .img_del",function(){var a=$(this),b=_dialog({top:90,head:"Удаление категории расхода мастерской",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=a[0].tagName;)a=a.parent();var c={op:"expense_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($("#spisok").html(a.html),b.close(),_msg("Удалено!"),sortable()):b.abort()},"json")}})}).ready(function(){$("#setup_info").length&&
($("#info_save").click(function(){var a=$(this),b={op:"info_save",org_name:$.trim($("#org_name").val())};b.org_name?(a.addClass("busy"),$.post(AJAX_SETUP,b,function(b){a.removeClass("busy");b.success&&_msg("Сохранено.")},"json")):(a.vkHint({msg:'<span class="red">Не указано название организации</span>',remove:1,indent:40,show:1,top:-57,left:-5}),$("#org_name").focus())}),$("#info_del").click(function(){var a=_dialog({top:150,width:300,head:"Удаление мастерской",content:"<center>Вы действительно хотите<BR>удалить мастерскую и все данные?</center>",
butSubmit:"&nbsp;&nbsp;&nbsp;&nbsp;Да&nbsp;&nbsp;&nbsp;&nbsp;",submit:function(){a.process();$.post(AJAX_SETUP,{op:"info_del"},function(b){b.success?location.href=URL:a.abort()},"json")}})}));$("#setup_rules").length&&($(".g-save").click(function(){function a(a){c.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-57,left:-6,indent:40,show:1,remove:1})}var b={op:"setup_worker_save",viewer_id:RULES_VIEWER_ID,first_name:$("#first_name").val(),last_name:$("#last_name").val(),post:$("#post").val()},c=
$(this);b.first_name?b.last_name?(c.addClass("busy"),$.post(AJAX_MAIN,b,function(a){c.removeClass("busy");a.success&&_msg("Сохранено.")},"json")):(a("Не указана фамилия"),$("#last_name").focus()):(a("Не указано имя"),$("#first_name").focus())}),$("#rules_appenter")._check(function(a){$(".app-div")[(0==a?"add":"remove")+"Class"]("dn");$("#rules_info")._check(0);$("#rules_worker")._check(0);$("#rules_rules")._check(0);$("#rules_income")._check(0);$("#rules_historyshow")._check(0);$("#rules_money")._dropdown(0)}),
$("#rules_money")._dropdown({spisok:[{uid:0,title:"только свои"},{uid:1,title:"все платежи"}]}),$(".rules-save").click(function(){var a={op:"worker_rules_save",viewer_id:RULES_VIEWER_ID,rules_appenter:$("#rules_appenter").val(),rules_info:$("#rules_info").val(),rules_worker:$("#rules_worker").val(),rules_rules:$("#rules_rules").val(),rules_income:$("#rules_income").val(),rules_historyshow:$("#rules_historyshow").val(),rules_money:$("#rules_money").val()},b=$(this);b.hasClass("busy")||(b.addClass("busy"),
$.post(AJAX_SETUP,a,function(a){b.removeClass("busy");a.success&&_msg("Права сохранены.")},"json"))}),$(".dop-save").click(function(){var a={op:"worker_dop_save",viewer_id:RULES_VIEWER_ID,rules_getmoney:$("#rules_getmoney").val()},b=$(this);b.hasClass("busy")||(b.addClass("busy"),$.post(AJAX_SETUP,a,function(a){b.removeClass("busy");a.success&&_msg("Дополнительные настройки сохранены.")},"json"))}))});
