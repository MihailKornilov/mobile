var AJAX_SETUP=APP_HTML+"/ajax/setup.php?"+VALUES;
$(document).on("click","#setup_info #devs div",function(){function b(b,c){$("#devs span").remove();a.prepend("<span><em"+(c?' class="err"':"")+">"+b+"</em></span>").find("span").delay(1500).fadeOut(1500,function(){$(this).remove()})}for(var a=$(this),c=a.parent().find("input"),e=[],d=0;d<c.length;d++){var g=c.eq(d);1==g.val()&&e.push(g.attr("id"))}e.length?(c={op:"info_devs_set",devs:e.join()},$.post(AJAX_SETUP,c,function(a){a.success&&b("Изменения сохранены")},"json")):b("Не сохранено!<br />Необходимо выбрать<br />минимум одну категорию",
!0)}).on("click","#setup_worker .add",function(){function b(){if(!d.hasClass("busy")){e=0;$(".res").remove();var a={user_ids:$.trim($("#viewer_id").val()),fields:"photo_50",v:5.2};a.user_ids&&(/vk.com/.test(a.user_ids)&&(a.user_ids=a.user_ids.split("vk.com/")[1]),/\?/.test(a.user_ids)&&(a.user_ids=a.user_ids.split("?")[0]),/#/.test(a.user_ids)&&(a.user_ids=a.user_ids.split("#")[0]),d.addClass("busy"),VK.api("users.get",a,function(a){d.removeClass("busy");console.log(a);a.response&&(a=a.response[0],
d.after('<table class="res"><tr><td class="photo"><img src='+a.photo_50+'><td class="name">'+a.first_name+" "+a.last_name+"</table>"),e=a.id)}))}}function a(a,b){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:b,left:90})}var c=_dialog({top:50,width:350,head:"Добавление нового сотрудника",content:'<div id="setup_worker_add"><h1>Укажите адрес страницы пользователя или его<br />ID ВКонтакте:</h1><h2>Формат адреса может быть следующих видов:<br /><u>http://vk.com/id12345</u>, <u>http://vk.com/durov</u>.<br />Либо используйте ID пользователя: <u>id12345</u>, <u>durov</u>, <u>12345</u>.</h2><input type="text" id="viewer_id" /><div class="vkButton"><button>Найти</button></div><a class="manual">Или заполните данные вручную..</a><table class="manual_tab"><tr><td class="label">Имя:<td><input type="text" id="first_name" /><tr><td class="label">Фамилия:<td><input type="text" id="last_name" /><tr><td class="label">Пол:<td><input type="hidden" id="sex" /></table></div>',
butSubmit:"Добавить",submit:function(){var b={op:"worker_add",viewer_id:e,first_name:$("#first_name").val(),last_name:$("#last_name").val(),sex:$("#sex").val()};b.viewer_id||b.first_name||b.last_name?b.first_name&&b.last_name&&0==b.sex?a("Не указан пол",-47):(c.process(),$.post(AJAX_SETUP,b,function(b){b.success?(c.close(),_msg("Новый сотрудник успешно добавлен."),$("#spisok").html(b.html)):(c.abort(),a(b.text,-60))},"json")):a("Произведите поиск пользователя<br>или укажите вручную имя и фамилию",
-60)}}),e=0,d=$("#viewer_id").focus().keyEnter(b).next();d.click(b);$(".manual").click(function(){$(this).hide().next().show();$(".res").remove();e=0;$("#viewer_id").val("");$("#first_name").focus()});$("#sex")._radio({spisok:[{uid:2,title:"М"},{uid:1,title:"Ж"}]})}).on("click","#setup_worker .img_del",function(){for(var b=$(this);!b.hasClass("unit");)b=b.parent();var a=_dialog({top:110,width:250,head:"Удаление сотрудника",content:"<center>Подтвердите удаление сотрудника.</center>",butSubmit:"Удалить",
submit:function(){var c={op:"worker_del",viewer_id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?(a.close(),_msg("Сотрудник удален."),$("#spisok").html(b.html)):a.abort()},"json")}})}).on("click","#setup-service-cartridge .add",cartridgeNew).on("click","#setup-service-cartridge .img_edit",function(){function b(){var a={op:"cartridge_edit",id:c,name:$("#name").val(),cost_filling:_num($("#cost_filling").val()),cost_restore:_num($("#cost_restore").val()),cost_chip:_num($("#cost_chip").val())};
a.name?(f.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#spisok").html(a.html),f.close(),_msg("Изменено!")):f.abort()},"json")):(f.err("Не указано наименование"),$("#name").focus())}for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var c=a.attr("val"),e=a.find(".name").html(),d=a.find(".filling").html(),g=a.find(".restore").html(),a=a.find(".chip").html(),f=_dialog({top:40,width:400,head:"Редактирование данных картриджа",content:'<table class="setup-tab"><tr><td class="label"><b>Модель картриджа:</b><td><input type="text" id="name" value="'+
e+'" /><tr><td class="label">Заправка:<td><input type="text" id="cost_filling" class="money" maxlength="11" value="'+d+'" /> руб.<tr><td class="label">Восстановление:<td><input type="text" id="cost_restore" class="money" maxlength="11" value="'+g+'" /> руб.<tr><td class="label">Замена чипа:<td><input type="text" id="cost_chip" class="money" maxlength="11" value="'+a+'" /> руб.</table>',butSubmit:"Сохранить",submit:b});$("#name").focus();$("#name,#cost_filling,#cost_restore,#cost_chip").keyEnter(b)}).on("click",
"#setup-service-cartridge .img_del",function(){var b=$(this),a=_dialog({top:90,width:300,head:"Удаление картриджа",content:"<center><b>Подтвердите удаление картриджа.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=b[0].tagName;)b=b.parent();var c={op:"cartridge_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?($("#spisok").html(b.html),a.close(),_msg("Удалено!")):a.abort()},"json")}})}).on("click","#setup_invoice .add",function(){function b(){var b={op:"invoice_add",
name:$("#name").val(),about:$("#about").val()};b.name?(c.process(),$.post(AJAX_SETUP,b,function(b){b.success?($(".spisok").html(b.html),c.close(),_msg("Внесено!")):(c.abort(),a(b.text))},"json")):(a("Не указано наименование"),$("#name").focus())}function a(a){c.bottom.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}$(this);var c=_dialog({width:400,head:"Добавление нового счёта",content:'<table class="setup-tab"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="50" /><tr><td class="label topi">Описание:<td><textarea id="about"></textarea></table>',
submit:b});$("#name").focus().keyEnter(b)}).on("click","#setup_invoice .img_edit",function(){function b(){var b={op:"invoice_edit",id:e,name:$("#name").val(),about:$("#about").val()};b.name?(f.process(),$.post(AJAX_SETUP,b,function(b){b.success?($(".spisok").html(b.html),f.close(),_msg("Сохранено!")):(f.abort(),a(b.text))},"json")):(a("Не указано наименование"),$("#name").focus())}function a(a){f.bottom.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}for(var c=
$(this);"TR"!=c[0].tagName;)c=c.parent();var e=c.attr("val"),d=c.find(".name div").html(),g=c.find(".name pre").html();c.find(".type_id").val();var f=_dialog({width:400,head:"Редактирование данных счёта",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" value="'+d+'" /><tr><td class="label r top">Описание:<td><textarea id="about">'+g+"</textarea></table>",butSubmit:"Сохранить",submit:b});$("#name").focus().keyEnter(b)}).on("click",
"#setup_invoice .img_del",function(){var b=$(this),a=_dialog({top:90,width:300,head:"Удаление счёта",content:"<center><b>Подтвердите удаление счёта.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=b[0].tagName;)b=b.parent();var c={op:"setup_invoice_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?($(".spisok").html(b.html),a.close(),_msg("Удалено!")):a.abort()},"json")}})}).on("click","#setup_expense .add",function(){function b(){var b={op:"expense_add",
name:$("#name").val(),show_worker:$("#show_worker").val()};b.name?(a.process(),$.post(AJAX_SETUP,b,function(b){b.success?($("#spisok").html(b.html),a.close(),_msg("Внесено!"),sortable()):a.abort()},"json")):(a.bottom.vkHint({msg:"<span class=red>Не указано наименование</span>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var a=_dialog({width:400,head:"Добавление новой категории расхода мастерской",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" /><tr><td class="label r">Список сотрудников:<td><input id="show_worker" type="hidden" /></table>',
submit:b});$("#name").focus().keyEnter(b);$("#show_worker")._check()}).on("click","#setup_expense .img_edit",function(){function b(){var a={op:"expense_edit",id:c,name:$("#name").val(),show_worker:$("#show_worker").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#spisok").html(a.html),d.close(),_msg("Сохранено!"),sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:'<span class="red">Не указано наименование</span>',top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}
for(var a=$(this);"DD"!=a[0].tagName;)a=a.parent();var c=a.attr("val"),e=a.find(".name").html(),a=a.find(".worker").html()?1:0,d=_dialog({width:400,head:"Редактирование категории расхода мастерской",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="50" value="'+e+'" /><tr><td class="label r">Список сотрудников:<td><input id="show_worker" type="hidden" value="'+a+'" /></table>',butSubmit:"Сохранить",submit:b});$("#name").focus().keyEnter(b);
$("#show_worker")._check()}).on("click","#setup_expense .img_del",function(){var b=$(this),a=_dialog({top:90,head:"Удаление категории расхода мастерской",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=b[0].tagName;)b=b.parent();var c={op:"expense_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?($("#spisok").html(b.html),a.close(),_msg("Удалено!"),sortable()):a.abort()},"json")}})}).on("click","#setup_zayav_expense .add",
function(){function b(){var b={op:"zayav_expense_add",name:$.trim($("#name").val()),dop:$("#dop").val()};b.name?(a.process(),$.post(AJAX_SETUP,b,function(b){b.success?($(".spisok").html(b.html),a.close(),_msg("Внесено!"),sortable()):a.abort()},"json")):(a.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var a=_dialog({width:440,head:"Добавление новой категории расхода заявки",content:'<table class="setup-tab"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="50" /><tr><td class="label topi">Дополнительное поле:<td><input id="dop" type="hidden" /></table>',
submit:b});$("#name").focus().keyEnter(b);$("#dop")._radio({light:1,spisok:ZE_DOP})}).on("click","#setup_zayav_expense .img_edit",function(){function b(){var a={op:"zayav_expense_edit",id:c,name:$.trim($("#name").val()),dop:$("#dop").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено!"),sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),
$("#name").focus())}for(var a=$(this);"DD"!=a[0].tagName;)a=a.parent();var c=a.attr("val"),e=a.find(".name").html(),a=a.find(".hdop").val(),d=_dialog({width:440,head:"Редактирование категории расхода заявки",content:'<table class="setup-tab"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="50" value="'+e+'" /><tr><td class="label topi">Дополнительное поле:<td><input id="dop" type="hidden" value="'+a+'" /></table>',butSubmit:"Сохранить",submit:b});$("#name").focus().keyEnter(b);
$("#dop")._radio({light:1,spisok:ZE_DOP})}).on("click","#setup_zayav_expense .img_del",function(){var b=$(this),a=_dialog({top:90,width:300,head:"Удаление категории расхода заявки",content:"<center><b>Подтвердите удаление<br />категории расхода заявки.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=b[0].tagName;)b=b.parent();var c={op:"zayav_expense_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?($(".spisok").html(b.html),a.close(),_msg("Удалено!"),sortable()):
a.abort()},"json")}})}).ready(function(){$("#setup_info").length&&$("#info_del").click(function(){var b=_dialog({top:150,width:300,head:"Удаление мастерской",content:"<center>Вы действительно хотите<BR>удалить мастерскую и все данные?</center>",butSubmit:"&nbsp;&nbsp;&nbsp;&nbsp;Да&nbsp;&nbsp;&nbsp;&nbsp;",submit:function(){b.process();$.post(AJAX_SETUP,{op:"info_del"},function(a){a.success?location.href=URL:b.abort()},"json")}})});$("#setup_rekvisit").length&&$(".vkButton").click(function(){var b=
$(this),a={op:"rekvisit",org_name:$("#org_name").val(),ogrn:$("#ogrn").val(),inn:$("#inn").val(),kpp:$("#kpp").val(),adres_yur:$("#adres_yur").val(),telefon:$("#telefon").val(),adres_ofice:$("#adres_ofice").val(),schet:$("#schet").val()};b.addClass("busy");$.post(AJAX_SETUP,a,function(a){b.removeClass("busy");a.success&&_msg("Информация сохранена.")},"json")});$("#setup-service").length&&$(".s-cartridge-toggle").click(function(){for(var b=$(this),a=b,c={op:"cartridge_toggle",v:b.hasClass("off")?0:
1};!a.hasClass("unit");)a=a.parent();var e=a.find("h1");e.hasClass("_busy")||(e.addClass("_busy"),$.post(AJAX_SETUP,c,function(b){e.removeClass("_busy");b.success&&(a[(c.v?"add":"remove")+"Class"]("on"),_msg("Выполнено!"))},"json"))});$("#setup_rules").length&&($(".g-save").click(function(){function b(a){c.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-57,left:-6,indent:40,show:1,remove:1})}var a={op:"worker_name_save",viewer_id:RULES_VIEWER_ID,first_name:$("#first_name").val(),last_name:$("#last_name").val(),
post:$("#post").val()},c=$(this);a.first_name?a.last_name?(c.addClass("busy"),$.post(AJAX_SETUP,a,function(a){c.removeClass("busy");a.success&&_msg("Сохранено.")},"json")):(b("Не указана фамилия"),$("#last_name").focus()):(b("Не указано имя"),$("#first_name").focus())}),$("#rules_appenter")._check(function(b){$(".app-div")[(0==b?"add":"remove")+"Class"]("dn");$("#rules_info")._check(0);$("#rules_worker")._check(0);$("#rules_rules")._check(0);$("#rules_income")._check(0);$("#rules_historyshow")._check(0);
$("#rules_money")._dropdown(0)}),$("#rules_money")._dropdown({spisok:[{uid:0,title:"только свои"},{uid:1,title:"все платежи"}]}),$(".rules-save").click(function(){var b={op:"worker_rules_save",viewer_id:RULES_VIEWER_ID,rules_appenter:$("#rules_appenter").val(),rules_info:$("#rules_info").val(),rules_worker:$("#rules_worker").val(),rules_rules:$("#rules_rules").val(),rules_income:$("#rules_income").val(),rules_historyshow:$("#rules_historyshow").val(),rules_historytransfer:$("#rules_historytransfer").val(),
rules_money:$("#rules_money").val()},a=$(this);a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_SETUP,b,function(b){a.removeClass("busy");b.success&&_msg("Права сохранены.")},"json"))}),$(".dop-save").click(function(){var b={op:"worker_dop_save",viewer_id:RULES_VIEWER_ID,rules_money_procent:$("#rules_money_procent").val()},a=$(this);a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_SETUP,b,function(b){a.removeClass("busy");b.success&&_msg("Дополнительные настройки сохранены.")},"json"))}))});
