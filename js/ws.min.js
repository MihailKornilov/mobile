var scannerWord="",scannerTime=0,scannerTimer,scannerDialog,scannerDialogShow=!1,charSpisok={48:"0",49:1,50:2,51:3,52:4,53:5,54:6,55:7,56:8,57:9,65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",189:"-"},modelImageGet=function(){var a={op:"model_img_get",model_id:$("#dev_model").val()},b=$("#device_image");b.html("");0<a.model_id&&(b.addClass("busy"),$.post(AJAX_MAIN,
a,function(a){if(a.success)b.html(a.img).find("img").on("load",function(){$(this).show().parent().removeClass("busy")})},"json"))},_valueColors=function(a,b){var c=$("#colors");if(!c.length)return!1;c.html('<input type="hidden" id="color_id" value="'+_num(a)+'" /><tt>-</tt><input type="hidden" id="color_dop" value="'+_num(b)+'" />');$("#color_id")._select({width:120,title0:"Цвет не указан",spisok:COLOR_SPISOK,func:_valueColorSet});_valueColorSet(a)},_valueColorSet=function(a){$("#colors").find("tt")[a?
"show":"hide"]();$("#color_dop")._select(a?{width:120,title0:"Цвет не указан",spisok:COLOR_SPISOK,func:function(a){$("#color_id")._select(a?COLORPRE_SPISOK:COLOR_SPISOK)._select($("#color_id").val())}}:"remove")},zayavEdit=function(){var a=_dialog({width:420,top:30,head:"Заявка №"+ZAYAV.nomer+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label r">Клиент:\t\t<td><input type="hidden" id="client_id" value="'+ZAYAV.client_id+'"><tr><td class="label r top">Устройство:<td><table><td id="dev"><td id="device_image"></table><tr><td><td>'+
ZAYAV.images+'<tr><td class="label r">IMEI:\t\t  <td><input type="text" id="imei" maxlength="20" value="'+ZAYAV.imei+'"><tr><td class="label r">Серийный номер:<td><input type="text" id="serial" maxlength="30" value="'+ZAYAV.serial+'"><tr><td class="label r">Цвет:<td id="colors"><tr class="tr_equip'+(ZAYAV.equip?"":" dn")+'"><td class="label r top">Комплектация:<td class="equip_spisok">'+ZAYAV.equip+'<tr><td class="label r">Диагностика:<td><input TYPE="hidden" id="diagnost" value="'+ZAYAV.diagnost+
'" /><tr><td class="label">Стоимость ремонта:<td><input type="text" class="money" id="pre_cost" maxlength="11" value="'+(ZAYAV.pre_cost?ZAYAV.pre_cost:"")+'" /> руб.</table>',butSubmit:"Сохранить",submit:function(){var b,c={op:"zayav_edit",zayav_id:ZAYAV.id,client_id:$("#client_id").val(),device:$("#dev_device").val(),vendor:$("#dev_vendor").val(),model:$("#dev_model").val(),imei:$.trim($("#imei").val()),serial:$.trim($("#serial").val()),color_id:$("#color_id").val(),color_dop:$("#color_dop").val(),
equip:"",diagnost:$("#diagnost").val(),pre_cost:$("#pre_cost").val()};if(!$(".tr_equip").hasClass("dn")){for(var d=$(".equip_spisok input"),f=[],e=0;e<d.length;e++){var h=d.eq(e);1==h.val()&&f.push(h.attr("id").split("_")[1])}c.equip=f.join()}0==c.deivce?b="Не выбрано устройство":0==c.client_id?b="Не выбран клиент":c.pre_cost&&!REGEXP_NUMERIC.test(c.pre_cost)?(b="Некорректно указана предварительная стоимость",$("#pre_cost").focus()):(a.process(),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),
_msg("Данные изменены!"),document.location.reload()):a.abort()},"json"));b&&a.bottom.vkHint({msg:'<SPAN class="red">'+b+"</SPAN>",top:-47,left:107,show:1,remove:1})}});$("#client_id").clientSel({width:267});$("#client_id_select").vkHint({msg:"Если изменяется клиент, то начисления и платежи заявки применяются на нового клиента.",width:200,top:-83,left:-2,delayShow:1500});$("#dev").device({width:190,device_id:ZAYAV.device,vendor_id:ZAYAV.vendor,model_id:ZAYAV.model,add:1,func:zayavDevSelect});modelImageGet();
imageSortable();_valueColors(ZAYAV.color_id,ZAYAV.color_dop);$("#diagnost")._check()},zayavFilter=function(){var a={op:"zayav_spisok",find:$("#find")._search("val"),sort:$("#sort").val(),desc:$("#desc").val(),status:$("#status").val(),finish:$("#day_finish").val(),diff:$("#diff").val(),zpzakaz:$("#zpzakaz").val(),executer:$("#executer").val(),device:$("#dev_device").val(),vendor:$("#dev_vendor").val(),model:$("#dev_model").val(),diagnost:$("#diagnost").val(),place:$("#device_place").val()},b="";"1"!=
a.sort&&(b+=".sort="+a.sort);"0"!=a.desc&&(b+=".desc="+a.desc);a.find?b+=".find="+escape(a.find):(0<a.status&&(b+=".status="+a.status),"0000-00-00"!=a.finish&&(b+=".finish="+a.finish),0<a.diff&&(b+=".diff=1"),0<a.zpzakaz&&(b+=".zpzakaz="+a.zpzakaz),0<a.executer&&(b+=".executer="+a.executer),0<a.device&&(b+=".device="+a.device),0<a.vendor&&(b+=".vendor="+a.vendor),0<a.model&&(b+=".model="+a.model),0<a.diagnost&&(b+=".diagnost=1"),0!=a.place&&(b+=".place="+a.place));VK.callMethod("setLocation",hashLoc+
b);_cookie(VIEWER_ID+"_zayav_find",escape(a.find));_cookie(VIEWER_ID+"_zayav_sort",a.sort);_cookie(VIEWER_ID+"_zayav_desc",a.desc);_cookie(VIEWER_ID+"_zayav_status",a.status);_cookie(VIEWER_ID+"_zayav_finish",a.finish);_cookie(VIEWER_ID+"_zayav_diff",a.diff);_cookie(VIEWER_ID+"_zayav_zpzakaz",a.zpzakaz);_cookie(VIEWER_ID+"_zayav_executer",a.executer);_cookie(VIEWER_ID+"_zayav_device",a.device);_cookie(VIEWER_ID+"_zayav_vendor",a.vendor);_cookie(VIEWER_ID+"_zayav_model",a.model);_cookie(VIEWER_ID+
"_zayav_diagnost",a.diagnost);_cookie(VIEWER_ID+"_zayav_place",escape(a.place));return a},zayavSpisok=function(a,b){_filterSpisok(ZAYAV,a,b);$(".condLost")[(ZAYAV.find?"add":"remove")+"Class"]("hide");$.post(AJAX_MAIN,ZAYAV,function(a){a.success&&($(".result").html(a.all),$("#spisok").html(a.spisok))},"json")},zayavMoneyUpdate=function(){$.post(AJAX_MAIN,{op:"zayav_money_update",zayav_id:ZAYAV.id},function(a){a.success&&($("b.acc").html(a.acc),$(".acc_tr")[(a.acc?"remove":"add")+"Class"]("dn"),$("b.op").html(a.opl),
$(".op_tr")[(a.opl?"remove":"add")+"Class"]("dn"),$(".dopl")[(a.diff?"remove":"add")+"Class"]("dn").html((0<a.diff?"+":"")+a.diff),$(".ze-spisok").remove(),$("#ze_acc").html(a.acc_sum).after(a.html),ZAYAV.expense=a.array,ZAYAV.worker_zp=a.worker_zp)},"json")},zayavDevSelect=function(a){modelImageGet(a);0==a.device_id?($(".equip_spisok").html(""),$(".tr_equip").addClass("dn")):0==a.vendor_id&&0==a.model_id&&$.post(AJAX_MAIN,{op:"equip_check_get",device_id:a.device_id},function(a){a.spisok?($(".equip_spisok").html(a.spisok),
$(".tr_equip").removeClass("dn")):($(".equip_spisok").html(""),$(".tr_equip").addClass("dn"))},"json")},zayavPlace=function(a){window.PLACE_OTHER||(DEVPLACE_SPISOK.push({uid:0,title:'<div id="place-other-div">другое:<input type="text" id="place_other" class="dn" /></div>'}),window.PLACE_OTHER=1);$("#place")._radio({spisok:DEVPLACE_SPISOK,light:1,func:function(b){$("#place_other")[(b?"add":"remove")+"Class"]("dn");b||$("#place_other").val("").focus();"function"==typeof a&&a()}})},kvitHtml=function(a){window.open(APP_HTML+
"/view/kvit_html.php?"+VALUES+"&id="+a,"kvit","scrollbars=yes,resizable=yes,status=no,location=no,toolbar=no,menubar=no,width=680,height=500,left=20,top=20")},cartridgeNew=function(a,b){function c(){var c={op:"cartridge_new",type_id:$("#type_id").val(),name:$("#name").val(),cost_filling:_num($("#cost_filling").val()),cost_restore:_num($("#cost_restore").val()),cost_chip:_num($("#cost_chip").val()),from:$("#setup-service-cartridge").length?"setup":""};c.name?(d.process(),$.post(AJAX_MAIN,c,function(e){e.success?
("setup"==c.from?$("#spisok").html(e.spisok):(CARTRIDGE_SPISOK=e.spisok,$("#"+a)._select(e.spisok),$("#"+a)._select(e.insert_id),b(e.insert_id)),d.close(),_msg("Внесено!")):d.abort()},"json")):(d.err("Не указано наименование"),$("#name").focus())}$(this);var d=_dialog({top:20,head:"Добавление нового картриджа",content:'<table id="cartridge-new-tab"><tr><td class="label r">Вид:<td><input type="hidden" id="type_id" value="1" /><tr><td class="label r"><b>Модель картриджа:</b><td><input type="text" id="name" /><tr><td class="label r">Заправка:<td><input type="text" id="cost_filling" class="money" maxlength="11" /> руб.<tr><td class="label r">Восстановление:<td><input type="text" id="cost_restore" class="money" maxlength="11" /> руб.<tr><td class="label r">Замена чипа:<td><input type="text" id="cost_chip" class="money" maxlength="11" /> руб.</table>',
submit:c});$("#type_id")._select({spisok:CARTRIDGE_TYPE});$("#name").focus();$("#name,#cost_filling,#cost_restore,#cost_chip").keyEnter(c)},zayavCartridgeAdd=function(){window.CLIENT||(CLIENT={id:0,fio:""});var a=_dialog({width:470,top:30,head:"Новая заявка на заправку картриджей",content:'<table id="cartridge-add-tab"><tr><td class="label">Клиент:<td><input type="hidden" id="client_id" value="'+CLIENT.id+'" /><b>'+CLIENT.fio+'</b><tr><td class="label"><b>Количество картриджей:</b><td><input type="text" id="count" /> шт.<tr><td class="label topi">Расчёт:<td><input type="hidden" id="pay_type" /><tr><td class="label topi">Список картриджей:<td id="crt"><tr><td class="label top">Заметка:<td><textarea id="comm"></textarea></table>',
submit:function(){var b={op:"zayav_cartridge_add",client_id:_num($("#client_id").val()),count:_num($("#count").val()),pay_type:_num($("#pay_type").val()),ids:$("#crt").cartridge("get"),comm:$("#comm").val()};b.client_id?b.count?b.pay_type?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+b.id+"&from=cartridge"):a.abort()},"json")):a.err("Укажите вид расчёта"):(a.err("Не указано количество картриджей"),$("#count").focus()):
a.err("Не указан клиент")}});CLIENT.id||$("#client_id").clientSel({add:1});$("#count").focus();$("#pay_type")._radio({light:1,spisok:PAY_TYPE});$("#crt").cartridge();$("#comm").autosize()},cartridgeFilter=function(){var a={op:"zayav_cartridge_spisok",sort:$("#sort").val(),desc:$("#desc").val(),status:$("#status").val(),paytype:$("#paytype").val(),noschet:$("#noschet").val()};_cookie(VIEWER_ID+"_cart_sort",a.sort);_cookie(VIEWER_ID+"_cart_desc",a.desc);_cookie(VIEWER_ID+"_cart_status",a.status);_cookie(VIEWER_ID+
"_cart_paytype",a.paytype);_cookie(VIEWER_ID+"_cart_noschet",a.noschet);return a},cartridgeSpisok=function(){var a=cartridgeFilter();$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,a,function(a){$("#mainLinks").removeClass("busy");a.success&&($(".result").html(a.all),$("#spisok").html(a.html))},"json")},zayavInfoCartridgeAdd=function(){var a=_dialog({width:470,top:30,head:"Добавление картриджей к заявке",content:'<table id="cartridge-add-tab"><tr><td class="label topi">Список картриджей:<td id="crt"></table>',
submit:function(){var b={op:"zayav_info_cartridge_add",zayav_id:ZAYAV.id,ids:$("#crt").cartridge("get")};b.ids?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),$("#cart-tab").html(b.html),_msg("Внесено.")):a.abort()},"json")):a.err("Не выбрано ни одного картриджа")}});$("#crt").cartridge()},zpNameSelect=function(a,b){window.ZPNAME||(window.ZPNAME={});ZPNAME.device_id=a;$("#name_id")._select({width:230,funcAdd:a?zpNameAdd:null,title0:a?"Наименование запчасти не выбрано":"Сначала выберите устройство",
spisok:ZPNAME_SPISOK[a]})._select(b||0)},zpNameAdd=function(){function a(){var a={op:"zpname_add",device_id:ZPNAME.device_id,name:$("#name").val()};a.name?(b.process(),$.post(AJAX_MAIN,a,function(d){d.success?($(".sa-equip").length?$("#zp-spisok").html(d.zp):(ZPNAME_SPISOK[ZPNAME.device_id].push({uid:d.id,title:a.name}),$("#name_id")._select(ZPNAME_SPISOK[ZPNAME.device_id])._select(d.id)),b.close(),_msg("Внесено!")):b.abort()},"json")):(b.err("Не указана запчасть"),$("#name").focus())}var b=_dialog({width:390,
head:"Добавление нового наименования запчасти",content:'<table id="zpname-add-tab"><tr><td class="label">Устройство:<td><b>'+DEV_ASS[ZPNAME.device_id]+'</b><tr><td class="label">Запчасть:<td><input id="name" type="text" maxlength="100" /></table>',submit:a});$("#name").focus().keyEnter(a)};
$.fn.device=function(a){function b(){var b={op:"base_device_add",name:$("#daname").focus().val()};b.name?p(DEV_SPISOK,b.name)?f():(l.process(),$.post(AJAX_MAIN,b,function(c){l.abort();c.success&&(DEV_SPISOK.push({uid:c.id,title:b.name}),DEV_ASS[c.id]=name,t._select(DEV_SPISOK)._select(c.id),e(0),q.val(0)._select("remove"),a.func(r()),l.close())},"json")):f("Не указано название устройства.")}function c(){var a=t.val(),b={op:"base_vendor_add",device_id:a,name:$("#vaname").focus().val()};b.name?p(VENDOR_SPISOK[a],
b.name)?f():(l.process(),$.post(AJAX_MAIN,b,function(c){l.abort();c.success&&(VENDOR_SPISOK[a]||(VENDOR_SPISOK[a]=[]),VENDOR_SPISOK[a].push({uid:c.id,title:b.name}),VENDOR_ASS[c.id]=b.name,s._select(VENDOR_SPISOK[a])._select(c.id),h(0),l.close())},"json")):f("Не указано название производителя.")}function d(){var a=s.val(),b={op:"base_model_add",device_id:t.val(),vendor_id:a,name:$("#maname").focus().val()};b.name?p(MODEL_SPISOK[a],b.name)?f():(l.process(),$.post(AJAX_MAIN,b,function(c){l.abort();
c.success&&(MODEL_SPISOK[a]||(MODEL_SPISOK[a]=[]),MODEL_SPISOK[a].push({uid:c.id,title:b.name}),MODEL_ASS[c.id]=b.name,q._select(MODEL_SPISOK[a])._select(c.id),l.close())},"json")):f("Не указано название модели.")}function f(a){l.bottom.vkHint({msg:'<SPAN class="red">'+(a||"Такое название уже есть в списке.")+"</SPAN>",top:-47,left:53,indent:50,show:1,remove:1})}function e(b){void 0!=b&&(a.vendor_id=b);s.val(a.vendor_id);s._select({width:a.width,block:1,title0:u[a.type_no],spisok:VENDOR_SPISOK[t.val()],
func:function(b){q.val(0);b?h(0):q._select("remove");a.func(r())},funcAdd:a.vendor_funcAdd,bottom:3});s._select(a.vendor_id);a.vendor_id&&h()}function h(b){a.no_model||(void 0!=b&&(a.model_id=b),q.val(a.model_id),q._select({width:a.width,block:1,write:1,title0:v[a.type_no],spisok:MODEL_SPISOK[s.val()],limit:50,funcAdd:a.model_funcAdd,bottom:10,func:function(){a.func(r())}}),q._select(a.model_id))}function p(a,b){if(a){b=b.toLowerCase();for(var c=0;c<a.length;c++)if(a[c].title.toLowerCase()==b)return!0}return!1}
function r(){return{device_id:t.val(),vendor_id:s.val(),model_id:q.val()}}a=$.extend({width:150,func:function(){},func_device:function(){},type_no:0,device_id:0,vendor_id:0,model_id:0,device_multiselect:0,device_ids:null,vendor_ids:null,model_ids:null,add:0,device_funcAdd:null,vendor_funcAdd:null,model_funcAdd:null,no_model:0},a);var m=$(this),g=m.attr("id"),u=["Производитель не выбран","Любой производитель"],v=["Модель не выбрана","Любая модель"],l;m.html('<input type="hidden" id="'+g+'_device" value="'+
a.device_id+'"><input type="hidden" id="'+g+'_vendor" value="'+a.vendor_id+'"><input type="hidden" id="'+g+'_model" value="'+a.model_id+'">');var t=$("#"+g+"_device"),s=$("#"+g+"_vendor"),q=$("#"+g+"_model");if(a.device_ids)for(DEV_SPISOK=[],n=0;n<a.device_ids.length;n++)m=a.device_ids[n],DEV_SPISOK.push({uid:m,title:DEV_ASS[m]});if(a.vendor_ids){g={};for(k in VENDOR_SPISOK)for(n=0;n<VENDOR_SPISOK[k].length;n++)m=VENDOR_SPISOK[k][n],0<=a.vendor_ids.indexOf(m.uid)&&(void 0==g[k]&&(g[k]=[]),g[k].push(m));
VENDOR_SPISOK=g}if(a.model_ids){g={};for(k in MODEL_SPISOK)for(n=0;n<MODEL_SPISOK[k].length;n++)m=MODEL_SPISOK[k][n],0<=a.model_ids.indexOf(m.uid)&&(g[k]||(g[k]=[]),g[k].push(m));MODEL_SPISOK=g}0<a.add&&(a.device_funcAdd=function(){l=_dialog({width:300,head:"Добавление нoвого устройства",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="daname"></table>',submit:b});$("#daname").focus().keyEnter(b)},a.vendor_funcAdd=function(){l=_dialog({width:300,head:"Добавление нoвого производителя",
content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="vaname"></table>',submit:c});$("#vaname").focus().keyEnter(c)},a.model_funcAdd=function(){l=_dialog({width:300,head:"Добавление нoвой модели",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="maname"></table>',submit:d,focus:"#model_name"});$("#maname").focus().keyEnter(d)});t._select({width:a.width,block:1,multiselect:a.device_multiselect,title0:["Устройство не выбрано",
"Любое устройство"][a.type_no],spisok:DEV_SPISOK,func:function(b){s.val(0);q.val(0)._select("remove");var c=t.val();"0"==c||1<c.split(",").length?s._select("remove"):e(0);a.func(r());a.func_device(b)},funcAdd:a.device_funcAdd,bottom:3});("number"==typeof a.device_id&&a.device_id||"0"!=a.device_id&&1==a.device_id.split(",").length)&&e()};
$.fn.cartridge=function(a){function b(a){d.append('<input type="hidden" class="icar" id="car'+f+'" '+(a?'value="'+a+'" ':"")+"/>");$("#car"+f)._select({width:170,bottom:4,title0:"картридж не выбран",write:1,spisok:CARTRIDGE_SPISOK,func:c,funcAdd:function(a){cartridgeNew(a,c)}})}function c(a){if(a){a=d.find(".icar");for(e=0;e<a.length;e++)if(0==a.eq(e).val())return;f++;b()}}var d=$(this);d.attr("id");var f=1,e;if("string"==typeof a&&"get"==a){a=d.find(".icar");var h=[],p;for(e=0;e<a.length;e++)p=a.eq(e).val(),
0!=p&&h.push(p);return h.join()}if("object"==typeof a)for(h=0;h<a.length;h++)b(a[h]),f++;b()};
$(document).keydown(function(a){function b(){scannerWord="";scannerTime=0;scannerTimer&&clearTimeout(scannerTimer);scannerTimer=void 0;scannerDialogShow=!1}if(!scannerDialogShow)if(13==a.keyCode){var c=(new Date).getTime()-scannerTime;if(5<scannerWord.length&&300>c){scannerDialogShow=!0;scannerTimer=setTimeout(b,500);scannerDialog=_dialog({head:"Сканер штрих-кода",width:250,content:"Получен код: <b>"+scannerWord+"</b>",butSubmit:"Поиск"});var d={op:"scanner_word",word:scannerWord};scannerDialog.process();
$.post(AJAX_MAIN,d,function(b){if(b.success)if("input"==a.target.localName)scannerDialog.close();else if("zayav"==_cookie("p")&&"add"==_cookie("d"))$("#"+(b.imei?"imei":"serial")).val(d.word),scannerDialog.close();else if(b.zayav_id)document.location.href=URL+"&p=zayav&d=info&id="+b.zayav_id;else{var c="client"==_cookie("p")&&"info"==_cookie("d")?_cookie("id"):0;document.location.href=URL+"&p=zayav&d=add&"+(b.imei?"imei":"serial")+"="+d.word+(c?"&back=client&id="+c:"")}else scannerDialog.abort()},
"json")}}else scannerDialog&&(scannerDialog.close(),scannerDialog=void 0),scannerTimer&&clearTimeout(scannerTimer),scannerTimer=setTimeout(b,500),scannerWord||(scannerTime=(new Date).getTime()),scannerWord+=charSpisok[a.keyCode]||""}).on("mouseenter",".zayav_link",function(a){90>a.clientY&&$(this).find(".tooltip").css("top","12px")}).on("keyup","#zayavNomer",function(){var a=$(this);if(!a.hasClass("_busy")){a.next(".zayavNomerTab").remove().end().addClass("_busy");var b={op:"zayav_nomer_info",nomer:a.val()};
$.post(AJAX_MAIN,b,function(b){a.removeClass("_busy");b.success&&a.after(b.html)},"json")}}).on("click",".day-finish-link",function(a){a.stopPropagation();var b=$(this),c=b.hasClass("no-save")?0:1;if(!b.hasClass("_busy")){var d=_dialog({top:40,width:480,head:"Календарь ремонтов",load:1,butSubmit:""}),f={op:"zayav_day_finish",day:$("#day_finish").val(),zayav_spisok:$("#zayav").length};$.post(AJAX_MAIN,f,function(a){a.success?d.content.html(a.html):d.loadError()},"json");$(document).off("click","#zayav-finish-calendar td.d:not(.old),#fc-cancel,.fc-old-sel").on("click",
"#zayav-finish-calendar td.d:not(.old),#fc-cancel,.fc-old-sel",function(){b.hasClass("_busy")||(d.close(),b.addClass("_busy"),f={op:"zayav_day_finish_save",day:$(this).attr("val"),zayav_id:window.ZAYAV?ZAYAV.id:0,save:c},$.post(AJAX_MAIN,f,function(a){b.removeClass("_busy");a.success&&(b.prev("input").val(f.day),b.find("span").html(a.data),$("#zayav").length&&zayavSpisok(f.day,"finish"))},"json"))})}}).on("click","#zayav-finish-calendar .ch",function(){if(!$("#fc-head").hasClass("_busy")){$("#fc-head").addClass("_busy");
var a={op:"zayav_day_finish_next",mon:$(this).attr("val"),day:$("#day_finish").val(),zayav_spisok:$("#zayav").length};$.post(AJAX_MAIN,a,function(a){a.success?$("#zayav-finish-calendar").after(a.html).remove():$("#fc-head").removeClass("_busy")},"json")}}).on("click","#zayav-add",function(){function a(){location.href=URL+"&p=zayav&d=add&back="+c}var b=$(this),c=b.attr("val");if(b.hasClass("cartridge")){var d=_dialog({top:30,width:300,head:"Новая заявка",content:'<div id="zayav-add-tab"><div class="unit" id="go-device">Приём в ремонт<br />оборудования</div><div class="unit" id="cartridge-add">Заправка, восстановление<br />картриджей</div></div>',
butSubmit:""});$("#go-device").click(a);$("#cartridge-add").click(function(){d.close();zayavCartridgeAdd()})}else a()}).on("click",".zayav_unit",function(){_cookie("zback_scroll",VK_SCROLL);var a=$(this),b=a.hasClass("cart")?"&from=cartridge":"";location.href=URL+"&p=zayav&d=info&id="+a.attr("val")+b}).on("mouseenter",".zayav_unit",function(){var a=$(this),b=a.find(".note").html();b&&a.vkHint({width:150,msg:b,ugol:"left",top:10,left:a.width()+43,show:1,indent:5,delayShow:500})}).on("click","#zayav .clear",
function(){$("#find")._search("clear");$("#sort")._radio(1);$("#desc")._check(0);$("#status").rightLink(0);$("#day_finish").val("0000-00-00");$(".day-finish-link span").html("не указан");$("#diagnost")._check(0);$("#diff")._check(0);$("#zpzakaz")._radio(0);$("#executer")._select(0);$("#dev").device({width:155,type_no:1,device_ids:Z.device_ids,vendor_ids:Z.vendor_ids,model_ids:Z.model_ids,device_multiselect:1,func:zayavSpisok});$("#place")._select(0);ZAYAV.find="";ZAYAV.sort=1;ZAYAV.desc=0;ZAYAV.status=
0;ZAYAV.finish="0000-00-00";ZAYAV.diagnost=0;ZAYAV.diff=0;ZAYAV.zpzakaz=0;ZAYAV.executer=0;ZAYAV.device=0;ZAYAV.vendor=0;ZAYAV.model=0;ZAYAV.place=0;zayavSpisok()}).on("click","#zayav-cartridge ._next",function(){if(!$(this).hasClass("busy")){var a=$(this),b=cartridgeFilter();b.page=$(this).attr("val");a.addClass("busy");$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click","#zayav-cartridge .clear",function(){$("#sort")._radio(1);$("#desc")._check(0);
$("#status").rightLink(0);$("#paytype")._radio(0);$("#noschet")._check(0);cartridgeSpisok()}).on("click","#zayav-info .zedit",zayavEdit).on("click","#zayav-info .status_place",function(){var a=_dialog({top:30,width:420,head:"Изменение статуса заявки",content:'<div id="zayav-status">'+(1!=ZAYAV.status?'<div class="st c1" val="1">Ожидает выполнения<div class="about">Возобновление работы по заявке.</div></div>':"")+(2!=ZAYAV.status?'<div class="st c2" val="2">Выполнено<div class="about">Заявка выполнена успешно.<br />Не забудьте расписать расходы по заявке, проверьте начисления.<br />Добавьте напоминание, если необходимо.</div></div>':
"")+(3!=ZAYAV.status?'<div class="st c3" val="3">Заявка отменена<div class="about">Отмена заявки по какой-либо причине.</div></div>':"")+'<input type="hidden" id="zs-status" /><table id="zs-tab"><tr><td class="label r topi">Местонахождение устройства:<td><input type="hidden" id="place" value="-1" /><tr id="zs-srok" class="dn"><td class="label r">Срок выполнения:<td><input type="hidden" id="zs-day_finish" value="0000-00-00" /><div class="day-finish-link no-save"><span>не указан</span></div></table></div>',
butSubmit:"Сохранить",submit:function(){var b={op:"zayav_status_place",zayav_id:ZAYAV.id,status:1*$("#zs-status").val(),place:1*$("#place").val(),place_other:$("#place_other").val(),day_finish:$("#zs-day_finish").val()};0<b.dev_place&&(b.place_other="");b.status?-1==b.place||0==b.place&&""==b.place_other?(a.err("Не указано местонахождение устройства"),$("#place_other").focus()):1==b.status&&"0000-00-00"==b.day_finish?a.err("Не указан срок выполнения"):(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?
(a.close(),_msg("Изменения сохранены."),document.location.reload()):a.abort()},"json")):a.err("Выберите статус заявки")}});zayavPlace();$(".st").click(function(){var a=$(this),c=a.attr("val");a.parent().find(".st").hide();a.show();$("#zs-status").val(c);$("#zs-tab").show();1==c&&$("#zs-srok").removeClass("dn")})}).on("click","#zayav-info .cartridge_status",function(){function a(){var a={op:"zayav_cartridge_status",zayav_id:ZAYAV.id,status:_num($("#zs-status").val())};b.process();$.post(AJAX_MAIN,
a,function(a){a.success?(b.close(),_msg("Изменения сохранены."),document.location.reload()):b.abort()},"json")}var b=_dialog({top:30,width:420,head:"Изменение статуса заявки",content:'<div id="zayav-status">'+(1!=ZAYAV.status?'<div class="st c1" val="1">Ожидает выполнения<div class="about">Возобновление работы по заявке.</div></div>':"")+(2!=ZAYAV.status?'<div class="st c2" val="2">Выполнено<div class="about">Заявка выполнена успешно.<br />Не забудьте расписать расходы по заявке, проверьте начисления.<br />Добавьте напоминание, если необходимо.</div></div>':
"")+(3!=ZAYAV.status?'<div class="st c3" val="3">Заявка отменена<div class="about">Отмена заявки по какой-либо причине.</div></div>':"")+'<input type="hidden" id="zs-status" /></div>',butSubmit:"",submit:a});$(".st").click(function(){var b=$(this).attr("val");$("#zs-status").val(b);a()})}).on("click","#zayav-info .dev_place",function(){var a=_dialog({head:"Изменение местонахождения устройства",content:'<table class="device-add-tab"><tr><td class="label r topi">Местонахождение устройства:<td><input type="hidden" id="place" value="-1" /></table>',
butSubmit:"Сохранить",submit:function(){var b={op:"zayav_device_place",zayav_id:ZAYAV.id,place:1*$("#place").val(),place_other:$("#place_other").val()};0<b.dev_place&&(b.place_other="");-1==b.place||0==b.place&&""==b.place_other?(a.bottom.vkHint({msg:'<span class="red">Не указано местонахождение устройства</SPAN>',top:-47,left:80,indent:50,show:1,remove:1}),$("#place_other").focus()):(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Изменения сохранены."),document.location.reload()):
a.abort()},"json"))}});zayavPlace(ZAYAV.place_other)}).on("click","#zayav-info .zakaz",function(){var a=$(this),b={op:"zayav_zp_zakaz",zayav_id:ZAYAV.id,zp_id:a.parent().parent().attr("val")};$.post(AJAX_MAIN,b,function(b){b.success&&(a.html("Заказано!").attr("class","zakaz_ok"),_msg(b.msg))},"json")}).on("click","#zayav-info .zakaz_ok",function(){location.href=URL+"&p=zp&menu=3"}).on("click","#zayav-info .zpAdd",function(){var a=_dialog({top:40,width:400,head:"Внесение новой запчасти",content:'<div class="zayav_zp_add"><center>Добавление запчасти к устройству<br /><b>'+
DEV_ASS[ZAYAV.device]+" "+VENDOR_ASS[ZAYAV.vendor]+" "+MODEL_ASS[ZAYAV.model]+'</b>.</center><table style="border-spacing:6px"><tr><td class="label r">Наименование запчасти:<td><input type="hidden" id="name_id" /><tr><td class="label r">Версия:<td><input type="text" id="version" /><tr><td class="label r">Цвет:<td><input type="hidden" id="color_id" /></table></div>',submit:function(){var b={op:"zayav_zp_add",zayav_id:ZAYAV.id,name_id:_num($("#name_id").val()),version:$("#version").val(),color_id:$("#color_id").val()};
b.name_id?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(_msg("Внесение запчасти произведено"),a.close(),$("#zpSpisok").html(b.html)):a.abort()},"json")):a.err("Не выбрано наименование запчасти")}});zpNameSelect(ZAYAV.device);$("#color_id")._select({width:130,title0:"Цвет не указан",spisok:COLOR_SPISOK})}).on("click","#zayav-info .set",function(){var a=$(this).parent().parent(),b='<center class="zayav_zp_set">Установка запчасти<br />'+a.find("a:first").html()+".<br />"+(0<a.find(".color").length?
a.find(".color").html()+".<br />":"")+"<br />Информация об установке также<br />будет добавлена в заметки<br />и в расходы по заявке.</center>",c=_dialog({top:150,width:400,head:"Установка запчасти",content:b,butSubmit:"Установить",submit:function(){var b={op:"zayav_zp_set",zp_id:a.attr("val"),zayav_id:ZAYAV.id};c.process();$.post(AJAX_MAIN,b,function(b){b.success?(zayavMoneyUpdate(),c.close(),_msg("Установка запчасти произведена."),a.parent().html(b.zp_unit),$(".vkComment").after(b.comment).remove()):
c.abort()},"json")}})}).on("click",".zayav_kvit",function(){kvitHtml($(this).attr("val"))}).on("click","#zayav-info .zc-edit",function(){var a=_dialog({width:470,head:"Редактирование заявки",content:'<table id="cartridge-add-tab"><tr><td class="label">Клиент:<td><input type="hidden" id="client_id" value="'+ZAYAV.client_id+'" /><tr><td class="label"><b>Количество картриджей:</b><td><input type="text" id="count" value="'+ZAYAV.cartridge_count+'" /> шт.<tr><td class="label topi">Расчёт:<td><input type="hidden" id="pay_type" value="'+
ZAYAV.pay_type+'" /></table>',butSubmit:"Сохранить",submit:function(){var b={op:"zayav_cartridge_edit",zayav_id:ZAYAV.id,client_id:_num($("#client_id").val()),count:_num($("#count").val()),pay_type:_num($("#pay_type").val())};b.client_id?b.count?b.pay_type?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Заявка изменена"),document.location.reload()):a.abort()},"json")):a.err("Укажите вид расчёта"):a.err("Не указано количество картриджей"):a.err("Не указан клиент")}});$("#client_id").clientSel({add:1});
$("#pay_type")._radio({light:1,spisok:PAY_TYPE})}).on("click","#zayav-info #cart-add",zayavInfoCartridgeAdd).on("click","#zayav-info .cart-edit",function(){function a(){var a=0,b=_num($("#cart_id").val());1==$("#filling").val()&&(a=CARTRIDGE_FILLING[b]);1==$("#restore").val()&&(a+=CARTRIDGE_RESTORE[b]);1==$("#chip").val()&&(a+=CARTRIDGE_CHIP[b]);$("#cost").val(a)}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),d=b.find(".cart_id").val(),f=b.find(".filling").val(),e=b.find(".restore").val(),
h=b.find(".chip").val(),p=b.find(".cost").html(),b=b.find("u").html(),r=_dialog({width:470,top:30,head:"Действия по картриджу",content:'<table id="cart-edit-tab"><tr><td class="label">Картридж:<td><input type="hidden" id="cart_id" value="'+d+'" /><tr><td class="label topi">Действие:<td><input type="hidden" id="filling" value="'+f+'" /><input type="hidden" id="restore" value="'+e+'" /><input type="hidden" id="chip" value="'+h+'" /><tr><td class="label">Стоимость работ:<td><input type="text" class="money" id="cost" value="'+
p+'" /> руб.<tr><td class="label">Примечание:<td><input type="text" id="prim" value="'+b+'" /></table>',butSubmit:"Сохранить",submit:function(){var a={op:"zayav_info_cartridge_edit",id:c,cart_id:_num($("#cart_id").val()),filling:$("#filling").val(),restore:$("#restore").val(),chip:$("#chip").val(),cost:$("#cost").val(),prim:$("#prim").val()};a.cart_id?(r.process(),$.post(AJAX_MAIN,a,function(a){a.success?(r.close(),$("#cart-tab").html(a.html),_msg("Изменено.")):r.abort()},"json")):r.err("Не выбран картридж")}});
$("#cart_id")._select({write:1,spisok:CARTRIDGE_SPISOK,func:a});$("#filling")._check({name:"Заправка",func:a});$("#restore")._check({name:"Восстановление",func:a});$("#chip")._check({name:"Замена чипа",func:a})}).on("click","#zayav-info .cart-del",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var b=a.attr("val"),c=_dialog({head:"Удаление картриджа",content:"<center>Подтвердите удаление картриджа.</center>",butSubmit:"Удалить",submit:function(){var a={op:"zayav_info_cartridge_del",
id:b};c.process();$.post(AJAX_MAIN,a,function(a){a.success?(c.close(),$("#cart-tab").html(a.html),_msg("Удалено.")):c.abort()},"json")}})}).ready(function(){$("#zayav").length&&($("#find").vkHint({msg:"Поиск производится по<br />совпадению в названии<br />модели, imei и серийном<br />номере.",ugol:"right",top:-9,left:-178,delayShow:800})._search({width:153,focus:1,txt:"Быстрый поиск...",enter:1,func:zayavSpisok}).inp(ZAYAV.find),$("#sort")._radio(zayavSpisok),$("#desc")._check(zayavSpisok),$("#status").rightLink(zayavSpisok),
$("#diagnost")._check(zayavSpisok),$("#diff")._check(zayavSpisok),$("#zpzakaz")._radio(zayavSpisok),WORKER_SPISOK.push({uid:-1,title:"Не назначен",content:"<b>Не назначен</b>"}),$("#executer")._select({width:155,title0:"не указан",spisok:WORKER_SPISOK,func:zayavSpisok}),$("#dev").device({width:155,type_no:1,device_id:ZAYAV.device,vendor_id:ZAYAV.vendor,model_id:ZAYAV.model,device_multiselect:1,device_ids:Z.device_ids,vendor_ids:Z.vendor_ids,model_ids:Z.model_ids,func:function(a){ZAYAV.device=a.device_id;
ZAYAV.vendor=a.vendor_id;ZAYAV.model=a.model_id;zayavSpisok()}}),$("#place")._select({width:155,title0:"Любое местонахождение",spisok:DEVPLACE_SPISOK,func:zayavSpisok}),Z.cookie_id&&(VK.callMethod("scrollWindow",_cookie("zback_scroll")),$("#u"+Z.cookie_id).css("opacity",0.1).delay(400).animate({opacity:1},700)));$("#zayavAdd").length&&($("#client_id").clientSel({add:1}),$("#dev").device({width:190,add:1,device_ids:WS_DEVS,func:zayavDevSelect}),zayavPlace(),_valueColors(0),$("#comm").autosize(),$(".vkCancel").click(function(){location.href=
URL+"&p="+$(this).attr("val")}),$(".vkButton").click(function(){var a=$(this),b={op:"zayav_add",client_id:$("#client_id").val(),device:$("#dev_device").val(),vendor:$("#dev_vendor").val(),model:$("#dev_model").val(),equip:"",place:$("#place").val(),place_other:$("#place_other").val(),imei:$("#imei").val(),serial:$("#serial").val(),color:$("#color_id").val(),color_dop:$("#color_dop").val(),diagnost:$("#diagnost").val(),comm:$("#comm").val(),pre_cost:$("#pre_cost").val(),day_finish:$("#day_finish").val()};
if(!a.hasClass("busy")){if(!$(".tr_equip").hasClass("dn")){for(var c=$(".equip_spisok input"),d=[],f=0;f<c.length;f++){var e=c.eq(f);1==e.val()&&d.push(e.attr("id").split("_")[1])}b.equip=d.join()}c="";0==b.client_id?c="Не выбран клиент":0==b.device?c="Не выбрано устройство":"-1"==b.place||0==b.place&&!b.place_other?c="Не указано местонахождение устройства":!b.pre_cost||REGEXP_NUMERIC.test(b.pre_cost)&&0!=b.pre_cost?"0000-00-00"==b.day_finish?c="Не указан срок выполнения ремонта":(0<b.place&&(b.place_other=
""),a.addClass("busy"),$.post(AJAX_MAIN,b,function(b){b.success?location.href=URL+"&p=zayav&d=info&id="+b.id:a.removeClass("busy")},"json")):(c="Некорректно указана предварительная стоимость",$("#pre_cost").focus());c&&$(this).vkHint({msg:'<SPAN class="red">'+c+"</SPAN>",top:-48,left:201,indent:30,remove:1,show:1})}}));$("#zayav-info").length&&($("#zayav-action")._dropdown({head:"Действие",nosel:1,spisok:[{uid:1,title:"Редактировать данные заявки"},{uid:2,title:"<b>Распечатать квитанцию</b>"},{uid:3,
title:"Сформировать счёт"},{uid:4,title:"Изменить статус заявки"},{uid:5,title:"Начислить"},{uid:6,title:"<b>Принять платёж</b>"},{uid:7,title:"Возврат"},{uid:8,title:"Изменить расходы по заявке"},{uid:9,title:"Новое напоминание"},{uid:10,title:"Изменить срок выполнения заявки"},{uid:11,title:"Изменить местонахождение устройства"},{uid:12,title:"Добавить запчасть к устройству"},{uid:13,title:'<tt class="red">Удалить заявку</tt>'}],func:function(a){switch(a){case 1:zayavEdit();break;case 5:_accrualAdd();
break;case 6:_incomeAdd();break;case 7:_refundAdd();break;case 8:_zayavExpenseEdit();break;case 9:_remindAdd()}}}),$(".hist").click(function(){$("#dopLinks .sel").removeClass("sel");$(this).addClass("sel");$(".itab").addClass("h")}),$(".info").click(function(){$("#dopLinks .sel").removeClass("sel");$(this).addClass("sel");$(".itab").removeClass("h")}),$(".img_print").click(function(){function a(a){b.bottom.vkHint({msg:'<SPAN class="red">Не указана неисправность</SPAN>',top:a?-112:-47,left:a?127:97,
indent:50,show:1,remove:1})}var b=_dialog({width:380,top:30,head:"Заявка №"+ZAYAV.nomer+" - Формирование квитанции",content:'<table class="zayav-print"><tr><td class="label">Дата приёма:<td>'+PRINT.dtime+'<tr><td class="label top">Устройство:<td>'+PRINT.device+'<tr><td class="label">Цвет:<td>'+(PRINT.color?PRINT.color:"<i>не указан</i>")+'<tr><td class="label">IMEI:<td>'+(PRINT.imei?PRINT.imei:"<i>не указан</i>")+'<tr><td class="label">Серийный номер:<td>'+(PRINT.serial?PRINT.serial:"<i>не указан</i>")+
'<tr><td class="label">Комплектация:<td>'+(PRINT.equip?PRINT.equip:"<i>не указана</i>")+'<tr><td class="label">Заказчик:<td><b>'+PRINT.client+'</b><tr><td class="label">Телефон:<td>'+(PRINT.telefon?PRINT.telefon:"<i>не указан</i>")+'<tr><td class="label top">Неисправность:<td><textarea id="defect">'+PRINT.defect+'</textarea><tr><td colspan="2"><a id="preview"><span>Предварительный просмотр квитанции</span></a></table>',butSubmit:"Сохранить квитанцию",submit:function(){var c={op:"zayav_kvit",zayav_id:ZAYAV.id,
defect:$.trim($("#defect").val()),active:1};c.defect?(b.process(),$.post(AJAX_MAIN,c,function(a){a.success?(b.close(),_msg("Квитанция сохранена"),$("#kvit_spisok").html(a.html)):b.abort()},"json")):a()}});$("#defect").focus().autosize();$("#preview").click(function(){var b=$(this),d={op:"zayav_kvit",zayav_id:ZAYAV.id,defect:$.trim($("#defect").val())};b.hasClass("_busy")||(d.defect?(b.addClass("_busy"),$.post(AJAX_MAIN,d,function(a){b.removeClass("_busy");a.success&&kvitHtml(a.id)},"json")):a(1))})}),
$("#executer_id")._dropdown({title0:"не указан",spisok:WORKER_SPISOK,func:function(a){var b=$("#executer_td");a={op:"zayav_executer_change",zayav_id:ZAYAV.id,executer_id:a};b.addClass("_busy");$.post(AJAX_MAIN,a,function(a){b.removeClass("_busy");a.success&&_msg("Исполнитель изменён")},"json")}}),$("#executer_id_dropdown").vkHint({msg:"Сотрудник, который назначен на выполнение данной заявки.",delayShow:1E3,width:150,top:-79,left:-50}),$("#diagnost-ready").click(function(){var a=_dialog({width:450,
head:"Внесение результатов диагностики",content:'<div class="_info">После внесения результатов диагностики к заявке будет добавлен комментарий. При необходимости можно добавить напоминание.</div><table class="_dialog-tab" id="zayav-diagnost-tab"><tr><td class="label">Заявка:<td><b>№'+ZAYAV.nomer+'</b><tr><td class="label topi">Результаты:<td><textarea id="comm"></textarea><tr><td class="label">Добавить напоминание:<td><input type="hidden" id="diagnost-remind" /><tr class="remind-tr"><td class="label">Содержание:<td><input type="text" id="remind-txt" value="Сообщить результаты диагностики"><tr class="remind-tr"><td class="label">Дата:<td><input type="hidden" id="remind-day"></table>',
submit:function(){var b={op:"zayav_diagnost",zayav_id:ZAYAV.id,comm:$("#comm").val(),remind:_num($("#diagnost-remind").val()),remind_txt:$("#remind-txt").val(),remind_day:$("#remind-day").val()};b.comm?b.remind&&!b.remind_txt?(a.err("Не указано содержание напоминания"),$("#remind-txt").focus()):(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Результаты диагностики внесены"),document.location.reload()):a.abort()},"json")):(a.err("Не указан текст результата"),$("#comm").focus())}});
$("#comm").autosize().focus();$("#diagnost-remind")._check();$("#diagnost-remind_check").click(function(a){$(".remind-tr").toggle()});$("#remind-day")._calendar()}));$("#zayav-cartridge").length&&($("#sort")._radio(cartridgeSpisok),$("#desc")._check(cartridgeSpisok),$("#status").rightLink(cartridgeSpisok),$("#paytype")._radio(cartridgeSpisok),$("#noschet")._check(cartridgeSpisok))});
