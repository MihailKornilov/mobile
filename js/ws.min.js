var scannerWord="",scannerTime=0,scannerTimer,scannerDialog,scannerDialogShow=!1,charSpisok={48:"0",49:1,50:2,51:3,52:4,53:5,54:6,55:7,56:8,57:9,65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",189:"-"},modelImageGet=function(){var a={op:"model_img_get",model_id:_num($("#dev_model").val())},b=$("#device_image");b.html("");a.model_id&&(b.addClass("busy"),$.post(AJAX_MAIN,
a,function(a){if(a.success)b.html(a.img).find("img").on("load",function(){$(this).show().parent().removeClass("busy")})},"json"))},zayavDevSelect=function(a){modelImageGet(a);a.device_id?a.vendor_id||a.model_id||$.post(AJAX_MAIN,{op:"equip_check_get",device_id:a.device_id},function(a){a.spisok?($("#equip-spisok").html(a.spisok),$("#equip-tr").removeClass("dn")):($("#equip-spisok").html(""),$("#equip-tr").addClass("dn"))},"json"):($("#equip-spisok").html(""),$("#equip-tr").addClass("dn"))},zayavPlace=
function(a){window.PLACE_OTHER||(DEVPLACE_SPISOK.push({uid:0,title:'<div id="place-other-div">другое:<input type="text" id="place_other" class="dn" /></div>'}),window.PLACE_OTHER=1);$("#device-place")._radio({spisok:DEVPLACE_SPISOK,light:1,func:function(b){$("#place_other")[(b?"add":"remove")+"Class"]("dn");b||$("#place_other").val("").focus();"function"==typeof a&&a()}})},zayavKvit=function(){var a=_dialog({width:380,top:30,head:"Заявка №"+ZI.nomer+" - Формирование квитанции",content:'<table class="zayav-print"><tr><td class="label">Дата приёма:<td>'+
KVIT.dtime+'<tr><td class="label top">Устройство:<td>'+KVIT.device+'<tr><td class="label">Цвет:<td>'+(KVIT.color?KVIT.color:"<i>не указан</i>")+'<tr><td class="label">IMEI:<td>'+(ZI.imei?ZI.imei:"<i>не указан</i>")+'<tr><td class="label">Серийный номер:<td>'+(ZI.serial?ZI.serial:"<i>не указан</i>")+'<tr><td class="label">Комплектация:<td>'+(KVIT.equip?KVIT.equip:"<i>не указана</i>")+'<tr><td class="label">Заказчик:<td><b>'+ZI.client_link+'</b><tr><td class="label">Телефон:<td>'+(KVIT.phone?KVIT.phone:
"<i>не указан</i>")+'<tr><td class="label top">Неисправность:<td><textarea id="defect">'+KVIT.defect+'</textarea><tr><td colspan="2"><a id="preview"><span>Предварительный просмотр квитанции</span></a></table>',butSubmit:"Сохранить квитанцию",submit:function(){var b={op:"zayav_kvit",zayav_id:ZI.id,defect:$.trim($("#defect").val()),active:1};b.defect?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Квитанция сохранена"),document.location.reload()):a.abort()},"json")):a.err("Не указана неисправность")}});
$("#defect").focus().autosize();$("#preview").click(function(){var b=$(this),c={op:"zayav_kvit",zayav_id:ZI.id,defect:$.trim($("#defect").val())};b.hasClass("_busy")||(c.defect?(b.addClass("_busy"),$.post(AJAX_MAIN,c,function(a){b.removeClass("_busy");a.success&&kvitHtml(a.id)},"json")):a.err("Не указана неисправность"))})},kvitHtml=function(a){window.open(APP_HTML+"/view/kvit_html.php?"+VALUES+"&id="+a,"kvit","scrollbars=yes,resizable=yes,status=no,location=no,toolbar=no,menubar=no,width=680,height=500,left=20,top=20")},
cartridgeNew=function(a,b){function c(){var c={op:"cartridge_new",type_id:$("#type_id").val(),name:$("#name").val(),cost_filling:_num($("#cost_filling").val()),cost_restore:_num($("#cost_restore").val()),cost_chip:_num($("#cost_chip").val()),from:$("#setup-service-cartridge").length?"setup":""};c.name?(d.process(),$.post(AJAX_MAIN,c,function(e){e.success?("setup"==c.from?$("#spisok").html(e.spisok):(CARTRIDGE_SPISOK=e.spisok,$("#"+a)._select(e.spisok),$("#"+a)._select(e.insert_id),b(e.insert_id)),
d.close(),_msg("Внесено!")):d.abort()},"json")):(d.err("Не указано наименование"),$("#name").focus())}$(this);var d=_dialog({top:20,head:"Добавление нового картриджа",content:'<table id="cartridge-new-tab"><tr><td class="label r">Вид:<td><input type="hidden" id="type_id" value="1" /><tr><td class="label r"><b>Модель картриджа:</b><td><input type="text" id="name" /><tr><td class="label r">Заправка:<td><input type="text" id="cost_filling" class="money" maxlength="11" /> руб.<tr><td class="label r">Восстановление:<td><input type="text" id="cost_restore" class="money" maxlength="11" /> руб.<tr><td class="label r">Замена чипа:<td><input type="text" id="cost_chip" class="money" maxlength="11" /> руб.</table>',
submit:c});$("#type_id")._select({spisok:CARTRIDGE_TYPE});$("#name").focus();$("#name,#cost_filling,#cost_restore,#cost_chip").keyEnter(c)},cartridgeSchetSet=function(a){a={op:"zayav_cartridge_schet_set",schet_id:a,ids:_checkAll()};$.post(AJAX_MAIN,a,function(a){a.success&&location.reload()},"json")},zayavCartridgeAdd=function(){var a=_dialog({width:470,top:30,head:"Добавление картриджей к заявке",content:'<table id="cartridge-add-tab"><tr><td class="label topi">Список картриджей:<td id="crt"></table>',
submit:function(){var b={op:"zayav_info_cartridge_add",zayav_id:ZI.id,ids:$("#crt").cartridge("get")};b.ids?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),$("#zc-spisok").html(b.html),_msg()):a.abort()},"json")):a.err("Не выбрано ни одного картриджа")}});$("#crt").cartridge()},zayavCartridgeSchet=function(){if(!_checkAll())return!1;var a=_dialog({head:"Получение информации о картриджах",load:1,butSubmit:""}),b={op:"zayav_cartridge_ids",ids:_checkAll()};$.post(AJAX_MAIN,b,function(b){b.success?
(a.close(),_schetEdit({edit:1,client_id:ZI.client_id,client:ZI.client_link,zayav_id:ZI.id,arr:b.arr,func:cartridgeSchetSet})):a.loadError()},"json");return!0},zpNameSelect=function(a,b){window.ZPNAME||(window.ZPNAME={});ZPNAME.device_id=a;$("#name_id")._select({width:230,funcAdd:a?zpNameAdd:null,title0:a?"Наименование запчасти не выбрано":"Сначала выберите устройство",spisok:ZPNAME_SPISOK[a]})._select(b||0)},zpNameAdd=function(){function a(){var a={op:"zpname_add",device_id:ZPNAME.device_id,name:$("#name").val()};
a.name?(b.process(),$.post(AJAX_MAIN,a,function(d){d.success?($(".sa-equip").length?$("#zp-spisok").html(d.zp):(ZPNAME_SPISOK[ZPNAME.device_id].push({uid:d.id,title:a.name}),$("#name_id")._select(ZPNAME_SPISOK[ZPNAME.device_id])._select(d.id)),b.close(),_msg()):b.abort()},"json")):(b.err("Не указана запчасть"),$("#name").focus())}var b=_dialog({width:390,head:"Добавление нового наименования запчасти",content:'<table id="zpname-add-tab"><tr><td class="label">Устройство:<td><b>'+DEV_ASS[ZPNAME.device_id]+
'</b><tr><td class="label">Запчасть:<td><input id="name" type="text" maxlength="100" /></table>',submit:a});$("#name").focus().keyEnter(a)};
$.fn.device=function(a){function b(){var b={op:"base_device_add",name:$("#daname").focus().val()};b.name?p(DEV_SPISOK,b.name)?g():(h.process(),$.post(AJAX_MAIN,b,function(c){h.abort();c.success&&(DEV_SPISOK.push({uid:c.id,title:b.name}),DEV_ASS[c.id]=name,t._select(DEV_SPISOK)._select(c.id),e(0),q.val(0)._select("remove"),a.func(r()),h.close())},"json")):g("Не указано название устройства.")}function c(){var a=t.val(),b={op:"base_vendor_add",device_id:a,name:$("#vaname").focus().val()};b.name?p(VENDOR_SPISOK[a],
b.name)?g():(h.process(),$.post(AJAX_MAIN,b,function(c){h.abort();c.success&&(VENDOR_SPISOK[a]||(VENDOR_SPISOK[a]=[]),VENDOR_SPISOK[a].push({uid:c.id,title:b.name}),VENDOR_ASS[c.id]=b.name,s._select(VENDOR_SPISOK[a])._select(c.id),l(0),h.close())},"json")):g("Не указано название производителя.")}function d(){var a=s.val(),b={op:"base_model_add",device_id:t.val(),vendor_id:a,name:$("#maname").focus().val()};b.name?p(MODEL_SPISOK[a],b.name)?g():(h.process(),$.post(AJAX_MAIN,b,function(c){h.abort();
c.success&&(MODEL_SPISOK[a]||(MODEL_SPISOK[a]=[]),MODEL_SPISOK[a].push({uid:c.id,title:b.name}),MODEL_ASS[c.id]=b.name,q._select(MODEL_SPISOK[a])._select(c.id),h.close())},"json")):g("Не указано название модели.")}function g(a){h.bottom.vkHint({msg:'<SPAN class="red">'+(a||"Такое название уже есть в списке.")+"</SPAN>",top:-47,left:53,indent:50,show:1,remove:1})}function e(b){void 0!=b&&(a.vendor_id=b);s.val(a.vendor_id);s._select({width:a.width,block:1,title0:u[a.type_no],spisok:VENDOR_SPISOK[t.val()],
func:function(b){q.val(0);b?l(0):q._select("remove");a.func(r())},funcAdd:a.vendor_funcAdd,bottom:3});s._select(a.vendor_id);a.vendor_id&&l()}function l(b){a.no_model||(void 0!=b&&(a.model_id=b),q.val(a.model_id),q._select({width:a.width,block:1,write:1,title0:v[a.type_no],spisok:MODEL_SPISOK[s.val()],limit:50,funcAdd:a.model_funcAdd,bottom:10,func:function(){a.func(r())}}),q._select(a.model_id))}function p(a,b){if(a){b=b.toLowerCase();for(var c=0;c<a.length;c++)if(a[c].title.toLowerCase()==b)return!0}return!1}
function r(){return{device_id:a.device_multiselect?t.val():_num(t.val()),vendor_id:_num(s.val()),model_id:_num(q.val())}}a=$.extend({width:150,func:function(){},func_device:function(){},type_no:0,device_id:0,vendor_id:0,model_id:0,device_multiselect:0,device_ids:null,vendor_ids:null,model_ids:null,add:0,device_funcAdd:null,vendor_funcAdd:null,model_funcAdd:null,no_model:0},a);var m=$(this),f=m.attr("id"),u=["Производитель не выбран","Любой производитель"],v=["Модель не выбрана","Любая модель"],h;
m.html('<input type="hidden" id="'+f+'_device" value="'+a.device_id+'"><input type="hidden" id="'+f+'_vendor" value="'+a.vendor_id+'"><input type="hidden" id="'+f+'_model" value="'+a.model_id+'">');var t=$("#"+f+"_device"),s=$("#"+f+"_vendor"),q=$("#"+f+"_model");if(a.device_ids)for(DEV_SPISOK=[],n=0;n<a.device_ids.length;n++)m=a.device_ids[n],DEV_SPISOK.push({uid:m,title:DEV_ASS[m]});if(a.vendor_ids){f={};for(k in VENDOR_SPISOK)for(n=0;n<VENDOR_SPISOK[k].length;n++)m=VENDOR_SPISOK[k][n],0<=a.vendor_ids.indexOf(m.uid)&&
(void 0==f[k]&&(f[k]=[]),f[k].push(m));VENDOR_SPISOK=f}if(a.model_ids){f={};for(k in MODEL_SPISOK)for(n=0;n<MODEL_SPISOK[k].length;n++)m=MODEL_SPISOK[k][n],0<=a.model_ids.indexOf(m.uid)&&(f[k]||(f[k]=[]),f[k].push(m));MODEL_SPISOK=f}0<a.add&&(a.device_funcAdd=function(){h=_dialog({width:300,head:"Добавление нoвого устройства",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="daname"></table>',submit:b});$("#daname").focus().keyEnter(b)},a.vendor_funcAdd=
function(){h=_dialog({width:300,head:"Добавление нoвого производителя",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="vaname"></table>',submit:c});$("#vaname").focus().keyEnter(c)},a.model_funcAdd=function(){h=_dialog({width:300,head:"Добавление нoвой модели",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="maname"></table>',submit:d,focus:"#model_name"});$("#maname").focus().keyEnter(d)});t._select({width:a.width,
block:1,multiselect:a.device_multiselect,title0:["Устройство не выбрано","Любое устройство"][a.type_no],spisok:DEV_SPISOK,func:function(b){s.val(0);q.val(0)._select("remove");var c=t.val();"0"==c||1<c.split(",").length?s._select("remove"):e(0);a.func(r());a.func_device(b)},funcAdd:a.device_funcAdd,bottom:3});("number"==typeof a.device_id&&a.device_id||"0"!=a.device_id&&1==a.device_id.split(",").length)&&e()};
$.fn.cartridge=function(a){function b(a){d.append('<input type="hidden" class="icar" id="car'+g+'" '+(a?'value="'+a+'" ':"")+"/>");$("#car"+g)._select({width:170,bottom:4,title0:"картридж не выбран",write:1,spisok:CARTRIDGE_SPISOK,func:c,funcAdd:function(a){cartridgeNew(a,c)}})}function c(a){if(a){a=d.find(".icar");for(e=0;e<a.length;e++)if(0==a.eq(e).val())return;g++;b()}}var d=$(this);d.attr("id");var g=1,e;if("string"==typeof a&&"get"==a){a=d.find(".icar");var l=[],p;for(e=0;e<a.length;e++)p=a.eq(e).val(),
0!=p&&l.push(p);return l.join()}if("object"==typeof a)for(l=0;l<a.length;l++)b(a[l]),g++;b()};
$(document).keydown(function(a){function b(){scannerWord="";scannerTime=0;scannerTimer&&clearTimeout(scannerTimer);scannerTimer=void 0;scannerDialogShow=!1}if(!scannerDialogShow)if(13==a.keyCode){var c=(new Date).getTime()-scannerTime;if(5<scannerWord.length&&300>c){scannerDialogShow=!0;scannerTimer=setTimeout(b,500);scannerDialog=_dialog({head:"Сканер штрих-кода",width:250,content:"Получен код: <b>"+scannerWord+"</b>",butSubmit:"Поиск"});var d={op:"scanner_word",word:scannerWord};scannerDialog.process();
$.post(AJAX_MAIN,d,function(b){if(b.success)if("input"==a.target.localName)scannerDialog.close();else if("zayav"==_cookie("p")&&"add"==_cookie("d"))$("#"+(b.imei?"imei":"serial")).val(d.word),scannerDialog.close();else if(b.zayav_id)document.location.href=URL+"&p=zayav&d=info&id="+b.zayav_id;else{var c="client"==_cookie("p")&&"info"==_cookie("d")?_cookie("id"):0;document.location.href=URL+"&p=zayav&d=add&"+(b.imei?"imei":"serial")+"="+d.word+(c?"&back=client&id="+c:"")}else scannerDialog.abort()},
"json")}}else scannerDialog&&(scannerDialog.close(),scannerDialog=void 0),scannerTimer&&clearTimeout(scannerTimer),scannerTimer=setTimeout(b,500),scannerWord||(scannerTime=(new Date).getTime()),scannerWord+=charSpisok[a.keyCode]||""}).on("click","#zayav-dev-place-change",function(){var a=_dialog({width:420,head:"Изменение местонахождения устройства",content:'<table class="device-add-tab"><tr><td class="label r topi">Местонахождение устройства:<td><input type="hidden" id="device-place" value="-1" /></table>',
butSubmit:"Сохранить",submit:function(){var b={op:"zayav_device_place",zayav_id:ZI.id,place:_num($("#device-place").val()),place_other:$("#place_other").val()};b.place&&(b.place_other="");-1==b.place||0==b.place&&""==b.place_other?(a.err("Укажите местонахождение устройства"),$("#place_other").focus()):(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg(),document.location.reload()):a.abort()},"json"))}});zayavPlace(ZI.place_other)}).on("click","#_zayav-info #zp-add",function(){var a=
_dialog({top:40,width:400,head:"Внесение новой запчасти",content:'<div class="zayav_zp_add"><center>Добавление запчасти к устройству<br /><b>'+DEV_ASS[ZI.device_id]+" "+VENDOR_ASS[ZI.vendor_id]+" "+MODEL_ASS[ZI.model_id]+'</b>.</center><table style="border-spacing:6px"><tr><td class="label r">Наименование запчасти:<td><input type="hidden" id="name_id" /><tr><td class="label r">Версия:<td><input type="text" id="version" /><tr><td class="label r">Цвет:<td><input type="hidden" id="color_id" /></table></div>',
submit:function(){var b={op:"zayav_zp_add",zayav_id:ZI.id,name_id:_num($("#name_id").val()),version:$("#version").val(),color_id:$("#color_id").val()};b.name_id?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(_msg(),a.close(),$("#zayav-zp-spisok").html(b.html)):a.abort()},"json")):a.err("Не выбрано наименование запчасти")}});zpNameSelect(ZI.device_id);$("#color_id")._select({width:130,title0:"Цвет не указан",spisok:COLOR_SPISOK})}).on("click","#_zayav-info .zakaz",function(){var a=$(this),
b={op:"zayav_zp_zakaz",zayav_id:ZI.id,zp_id:a.parent().parent().attr("val")};$.post(AJAX_MAIN,b,function(b){b.success&&(a.html("Заказано!").attr("class","zakaz_ok"),_msg(b.msg))},"json")}).on("click","#_zayav-info .zakaz_ok",function(){location.href=URL+"&p=zp&menu=3"}).on("click","#_zayav-info .set",function(){var a=$(this).parent().parent(),b='<center class="zayav_zp_set">Установка запчасти<br />'+a.find("a:first").html()+".<br />"+(0<a.find(".color").length?a.find(".color").html()+".<br />":"")+
"<br />Информация об установке также<br />будет добавлена в заметки<br />и в расходы по заявке.</center>",c=_dialog({top:150,width:400,head:"Установка запчасти",content:b,butSubmit:"Установить",submit:function(){var b={op:"zayav_zp_set",zp_id:a.attr("val"),zayav_id:ZI.id};c.process();$.post(AJAX_MAIN,b,function(a){a.success?(c.close(),_msg(),location.reload()):c.abort()},"json")}})}).on("click","#diagnost-ready",function(){var a=_dialog({width:450,head:"Внесение результатов диагностики",content:'<div class="_info">После внесения результатов диагностики к заявке будет добавлен комментарий. При необходимости можно добавить напоминание.</div><table class="_dialog-tab" id="zayav-diagnost-tab"><tr><td class="label">Заявка:<td><b>№'+
ZI.nomer+'</b><tr><td class="label topi">Результаты:<td><textarea id="comm"></textarea><tr><td class="label">Добавить напоминание:<td><input type="hidden" id="diagnost-remind" /><tr class="remind-tr"><td class="label">Содержание:<td><input type="text" id="remind-txt" value="Сообщить результаты диагностики"><tr class="remind-tr"><td class="label">Дата:<td><input type="hidden" id="remind-day"></table>',submit:function(){var b={op:"zayav_diagnost",zayav_id:ZI.id,comm:$("#comm").val(),remind:_num($("#diagnost-remind").val()),
remind_txt:$("#remind-txt").val(),remind_day:$("#remind-day").val()};b.comm?b.remind&&!b.remind_txt?(a.err("Не указано содержание напоминания"),$("#remind-txt").focus()):(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Результаты диагностики внесены"),document.location.reload()):a.abort()},"json")):(a.err("Не указан текст результата"),$("#comm").focus())}});$("#comm").autosize().focus();$("#diagnost-remind")._check();$("#diagnost-remind_check").click(function(){$(".remind-tr").toggle()});
$("#remind-day")._calendar()}).on("click",".zayav_kvit",function(){kvitHtml($(this).attr("val"))}).on("keyup","#zayavNomer",function(){var a=$(this);if(!a.hasClass("_busy")){a.next(".zayavNomerTab").remove().end().addClass("_busy");var b={op:"zayav_nomer_info",nomer:a.val()};$.post(AJAX_MAIN,b,function(b){a.removeClass("_busy");b.success&&a.after(b.html)},"json")}}).on("click","#zayav-cartridge #cart-add",zayavCartridgeAdd).on("click","#zayav-cartridge .cart-edit",function(){function a(){var a=0,
b=_num($("#cart_id").val());1==$("#filling").val()&&(a=CARTRIDGE_FILLING[b]);1==$("#restore").val()&&(a+=CARTRIDGE_RESTORE[b]);1==$("#chip").val()&&(a+=CARTRIDGE_CHIP[b]);$("#cost").val(a)}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),d=b.find(".cart_id").val(),g=b.find(".filling").val(),e=b.find(".restore").val(),l=b.find(".chip").val(),p=b.find(".cost").html(),b=b.find("u").html(),r=_dialog({width:470,top:30,head:"Действия по картриджу",content:'<table id="cart-edit-tab"><tr><td class="label">Картридж:<td><input type="hidden" id="cart_id" value="'+
d+'" /><tr><td class="label topi">Действие:<td><input type="hidden" id="filling" value="'+g+'" /><input type="hidden" id="restore" value="'+e+'" /><input type="hidden" id="chip" value="'+l+'" /><tr><td class="label">Стоимость работ:<td><input type="text" class="money" id="cost" value="'+p+'" /> руб.<tr><td class="label">Примечание:<td><input type="text" id="prim" value="'+b+'" /></table>',butSubmit:"Сохранить",submit:function(){var a={op:"zayav_info_cartridge_edit",id:c,cart_id:_num($("#cart_id").val()),
filling:$("#filling").val(),restore:$("#restore").val(),chip:$("#chip").val(),cost:$("#cost").val(),prim:$("#prim").val()};a.cart_id?(r.process(),$.post(AJAX_MAIN,a,function(a){a.success?(r.close(),$("#zc-spisok").html(a.html),_msg()):r.abort()},"json")):r.err("Не выбран картридж")}});$("#cart_id")._select({write:1,spisok:CARTRIDGE_SPISOK,func:a});$("#filling")._check({name:"Заправка",func:a});$("#restore")._check({name:"Восстановление",func:a});$("#chip")._check({name:"Замена чипа",func:a})}).on("click",
"#zayav-cartridge .cart-del",function(){var a=_parent($(this));_dialogDel({id:a.attr("val"),head:"картриджа",op:"zayav_info_cartridge_del",func:function(){a.remove()}})});
