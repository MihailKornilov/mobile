var AJAX_WS=APP_HTML+"/ajax/ws.php?"+VALUES,scannerWord="",scannerTime=0,scannerTimer,scannerDialog,scannerDialogShow=!1,charSpisok={48:"0",49:1,50:2,51:3,52:4,53:5,54:6,55:7,56:8,57:9,65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",189:"-"},modelImageGet=function(){var a={op:"model_img_get",model_id:$("#dev_model").val()},b=$("#device_image");b.html("");0<a.model_id&&
(b.addClass("busy"),$.post(AJAX_WS,a,function(a){if(a.success)b.html(a.img).find("img").on("load",function(){$(this).show().parent().removeClass("busy")})},"json"))},colorSel=function(a){$("#color_id")._select({width:120,title0:"Цвет не указан",spisok:a,func:colorSelDop});$("#color_dop")._select({width:120,title0:"Цвет не указан",spisok:COLOR_SPISOK,func:function(a){colorSel(a?COLORPRE_SPISOK:COLOR_SPISOK)}})},colorSelDop=function(a){a?(0==$("#color_id_select").length&&colorSel(0<$("#color_dop").val()?
COLORPRE_SPISOK:COLOR_SPISOK),$(".color_dop").removeClass("dn")):(colorSel(COLOR_SPISOK),$("#color_dop")._select(0),$(".color_dop").addClass("dn"))},zayavFilter=function(){var a={op:"zayav_spisok",find:$("#find")._search("val"),sort:$("#sort").val(),desc:$("#desc").val(),status:$("#status").val(),finish:$("#day_finish").val(),diff:$("#diff").val(),zpzakaz:$("#zpzakaz").val(),executer:$("#executer").val(),device:$("#dev_device").val(),vendor:$("#dev_vendor").val(),model:$("#dev_model").val(),diagnost:$("#diagnost").val(),
place:$("#device_place").val()},b="";"1"!=a.status&&(a.finish="0000-00-00");"1"!=a.sort&&(b+=".sort="+a.sort);"0"!=a.desc&&(b+=".desc="+a.desc);a.find?b+=".find="+escape(a.find):(0<a.status&&(b+=".status="+a.status),"0000-00-00"!=a.finish&&(b+=".finish="+a.finish),0<a.diff&&(b+=".diff=1"),0<a.zpzakaz&&(b+=".zpzakaz="+a.zpzakaz),0<a.executer&&(b+=".executer="+a.executer),0<a.device&&(b+=".device="+a.device),0<a.vendor&&(b+=".vendor="+a.vendor),0<a.model&&(b+=".model="+a.model),0<a.diagnost&&(b+=".diagnost=1"),
0!=a.place&&(b+=".place="+a.place));VK.callMethod("setLocation",hashLoc+b);_cookie(VIEWER_ID+"_zayav_find",escape(a.find));_cookie(VIEWER_ID+"_zayav_sort",a.sort);_cookie(VIEWER_ID+"_zayav_desc",a.desc);_cookie(VIEWER_ID+"_zayav_status",a.status);_cookie(VIEWER_ID+"_zayav_finish",a.finish);_cookie(VIEWER_ID+"_zayav_diff",a.diff);_cookie(VIEWER_ID+"_zayav_zpzakaz",a.zpzakaz);_cookie(VIEWER_ID+"_zayav_executer",a.executer);_cookie(VIEWER_ID+"_zayav_device",a.device);_cookie(VIEWER_ID+"_zayav_vendor",
a.vendor);_cookie(VIEWER_ID+"_zayav_model",a.model);_cookie(VIEWER_ID+"_zayav_diagnost",a.diagnost);_cookie(VIEWER_ID+"_zayav_place",escape(a.place));return a},zayavSpisok=function(){var a=zayavFilter();$(".condLost")[(a.find?"add":"remove")+"Class"]("hide");$("#mainLinks").addClass("busy");$.post(AJAX_WS,a,function(a){$(".result").html(a.all);$("#spisok").html(a.html);$("#mainLinks").removeClass("busy")},"json")},zayavMoneyUpdate=function(){$.post(AJAX_WS,{op:"zayav_money_update",zayav_id:ZAYAV.id},
function(a){a.success&&($("b.acc").html(a.acc),$(".acc_tr")[(a.acc?"remove":"add")+"Class"]("dn"),$("b.op").html(a.opl),$(".op_tr")[(a.opl?"remove":"add")+"Class"]("dn"),$(".dopl")[(a.diff?"remove":"add")+"Class"]("dn").html((0<a.diff?"+":"")+a.diff),$(".ze-spisok").remove(),$("#ze_acc").html(a.acc_sum).after(a.html),ZAYAV.expense=a.array,ZAYAV.worker_zp=a.worker_zp)},"json")},zayavDevSelect=function(a){modelImageGet(a);0==a.device_id?($(".equip_spisok").html(""),$(".tr_equip").addClass("dn")):0==
a.vendor_id&&0==a.model_id&&$.post(AJAX_WS,{op:"equip_check_get",device_id:a.device_id},function(a){a.spisok?($(".equip_spisok").html(a.spisok),$(".tr_equip").removeClass("dn")):($(".equip_spisok").html(""),$(".tr_equip").addClass("dn"))},"json")},zayavPlace=function(a){void 0==a&&(a="");window.PLACE_OTHER||(DEVPLACE_SPISOK.push({uid:0,title:'другое: <input type="text" id="place_other" '+(a?"":'class="dn" ')+'maxlength="20" value="'+a+'" />'}),window.PLACE_OTHER=1);$("#place")._radio({spisok:DEVPLACE_SPISOK,
light:1,func:function(a){$("#place_other")[(0!=a?"add":"remove")+"Class"]("dn");0==a&&$("#place_other").val("").focus()}})},kvitHtml=function(a){window.open(APP_HTML+"/view/kvit_html.php?"+VALUES+"&id="+a,"kvit","scrollbars=yes,resizable=yes,status=no,location=no,toolbar=no,menubar=no,width=680,height=500,left=20,top=20")},cartridgeNew=function(a,b){function c(){var c={op:"cartridge_new",name:$("#name").val(),cost_filling:_num($("#cost_filling").val()),cost_restore:_num($("#cost_restore").val()),
cost_chip:_num($("#cost_chip").val()),from:$("#setup-service-cartridge").length?"setup":""};c.name?(e.process(),$.post(AJAX_WS,c,function(d){d.success?("setup"==c.from?$("#spisok").html(d.spisok):(CARTRIDGE_SPISOK=d.spisok,$("#"+a)._select(d.spisok),$("#"+a)._select(d.insert_id),b(d.insert_id)),e.close(),_msg("Внесено!")):e.abort()},"json")):(e.err("Не указано наименование"),$("#name").focus())}$(this);var e=_dialog({top:20,head:"Добавление нового картриджа",content:'<table id="cartridge-new-tab"><tr><td class="label"><b>Модель картриджа:</b><td><input type="text" id="name" /><tr><td class="label r">Заправка:<td><input type="text" id="cost_filling" class="money" maxlength="11" /> руб.<tr><td class="label r">Восстановление:<td><input type="text" id="cost_restore" class="money" maxlength="11" /> руб.<tr><td class="label r">Замена чипа:<td><input type="text" id="cost_chip" class="money" maxlength="11" /> руб.</table>',
submit:c});$("#name").focus();$("#name,#cost_filling,#cost_restore,#cost_chip").keyEnter(c)},zayavCartridgeAdd=function(){window.CLIENT||(CLIENT={id:0,fio:""});var a=_dialog({width:470,top:30,head:"Новая заявка на заправку картриджей",content:'<table id="cartridge-add-tab"><tr><td class="label">Клиент:<td><input type="hidden" id="client_id" value="'+CLIENT.id+'" /><b>'+CLIENT.fio+'</b><tr><td class="label"><b>Количество картриджей:</b><td><input type="text" id="count" /> шт.<tr><td class="label topi">Расчёт:<td><input type="hidden" id="pay_type" /><tr><td class="label topi">Список картриджей:<td id="crt"><tr><td class="label top">Заметка:<td><textarea id="comm"></textarea></table>',
submit:function(){var b={op:"zayav_cartridge_add",client_id:_num($("#client_id").val()),count:_num($("#count").val()),pay_type:_num($("#pay_type").val()),ids:$("#crt").cartridge("get"),comm:$("#comm").val()};b.client_id?b.count?b.pay_type?(a.process(),$.post(AJAX_WS,b,function(b){b.success?(a.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+b.id+"&from=cartridge"):a.abort()},"json")):a.err("Укажите вид расчёта"):(a.err("Не указано количество картриджей"),$("#count").focus()):
a.err("Не указан клиент")}});CLIENT.id||$("#client_id").clientSel({add:1});$("#count").focus();$("#pay_type")._radio({light:1,spisok:PAY_TYPE});$("#crt").cartridge();$("#comm").autosize()},cartridgeFilter=function(){var a={op:"zayav_cartridge_spisok",sort:$("#sort").val(),desc:$("#desc").val(),status:$("#status").val(),paytype:$("#paytype").val(),noschet:$("#noschet").val()};_cookie(VIEWER_ID+"_cart_sort",a.sort);_cookie(VIEWER_ID+"_cart_desc",a.desc);_cookie(VIEWER_ID+"_cart_status",a.status);_cookie(VIEWER_ID+
"_cart_paytype",a.paytype);_cookie(VIEWER_ID+"_cart_noschet",a.noschet);return a},cartridgeSpisok=function(){var a=cartridgeFilter();$("#mainLinks").addClass("busy");$.post(AJAX_WS,a,function(a){$("#mainLinks").removeClass("busy");a.success&&($(".result").html(a.all),$("#spisok").html(a.html))},"json")},zayavInfoCartridgeAdd=function(){var a=_dialog({width:470,top:30,head:"Добавление картриджей к заявке",content:'<table id="cartridge-add-tab"><tr><td class="label topi">Список картриджей:<td id="crt"></table>',
submit:function(){var b={op:"zayav_info_cartridge_add",zayav_id:ZAYAV.id,ids:$("#crt").cartridge("get")};b.ids?(a.process(),$.post(AJAX_WS,b,function(b){b.success?(a.close(),$("#cart-tab").html(b.html),_msg("Внесено.")):a.abort()},"json")):a.err("Не выбрано ни одного картриджа")}});$("#crt").cartridge()};
$.fn.device=function(a){function b(){var b={op:"base_device_add",name:$("#daname").focus().val()};b.name?p(DEV_SPISOK,b.name)?f():(q.process(),$.post(AJAX_WS,b,function(c){q.abort();c.success&&(DEV_SPISOK.push({uid:c.id,title:b.name}),DEV_ASS[c.id]=name,t._select(DEV_SPISOK)._select(c.id),d(0),r.val(0)._select("remove"),a.func(m()),q.close())},"json")):f("Не указано название устройства.")}function c(){var a=t.val(),b={op:"base_vendor_add",device_id:a,name:$("#vaname").focus().val()};b.name?p(VENDOR_SPISOK[a],
b.name)?f():(q.process(),$.post(AJAX_WS,b,function(c){q.abort();c.success&&(VENDOR_SPISOK[a]||(VENDOR_SPISOK[a]=[]),VENDOR_SPISOK[a].push({uid:c.id,title:b.name}),VENDOR_ASS[c.id]=b.name,s._select(VENDOR_SPISOK[a])._select(c.id),g(0),q.close())},"json")):f("Не указано название производителя.")}function e(){var a=s.val(),b={op:"base_model_add",device_id:t.val(),vendor_id:a,name:$("#maname").focus().val()};b.name?p(MODEL_SPISOK[a],b.name)?f():(q.process(),$.post(AJAX_WS,b,function(c){q.abort();c.success&&
(MODEL_SPISOK[a]||(MODEL_SPISOK[a]=[]),MODEL_SPISOK[a].push({uid:c.id,title:b.name}),MODEL_ASS[c.id]=b.name,r._select(MODEL_SPISOK[a])._select(c.id),q.close())},"json")):f("Не указано название модели.")}function f(a){q.bottom.vkHint({msg:'<SPAN class="red">'+(a||"Такое название уже есть в списке.")+"</SPAN>",top:-47,left:53,indent:50,show:1,remove:1})}function d(b){void 0!=b&&(a.vendor_id=b);s.val(a.vendor_id);s._select({width:a.width,block:1,title0:u[a.type_no],spisok:VENDOR_SPISOK[t.val()],func:function(b){r.val(0);
b?g(0):r._select("remove");a.func(m())},funcAdd:a.vendor_funcAdd,bottom:3});s._select(a.vendor_id);a.vendor_id&&g()}function g(b){void 0!=b&&(a.model_id=b);r.val(a.model_id);r._select({width:a.width,block:1,write:1,title0:v[a.type_no],spisok:MODEL_SPISOK[s.val()],limit:50,funcAdd:a.model_funcAdd,bottom:10,func:function(){a.func(m())}});r._select(a.model_id)}function p(a,b){if(a){b=b.toLowerCase();for(var c=0;c<a.length;c++)if(a[c].title.toLowerCase()==b)return!0}return!1}function m(){return{device_id:t.val(),
vendor_id:s.val(),model_id:r.val()}}a=$.extend({width:150,func:function(){},type_no:0,device_id:0,vendor_id:0,model_id:0,device_ids:null,vendor_ids:null,model_ids:null,add:0,device_funcAdd:null,vendor_funcAdd:null,model_funcAdd:null},a);var l=$(this),h=l.attr("id"),u=["Производитель не выбран","Любой производитель"],v=["Модель не выбрана","Любая модель"],q;l.html('<input type="hidden" id="'+h+'_device" value="'+a.device_id+'"><input type="hidden" id="'+h+'_vendor" value="'+a.vendor_id+'"><input type="hidden" id="'+
h+'_model" value="'+a.model_id+'">');var t=$("#"+h+"_device"),s=$("#"+h+"_vendor"),r=$("#"+h+"_model");if(a.device_ids)for(DEV_SPISOK=[],n=0;n<a.device_ids.length;n++)l=a.device_ids[n],DEV_SPISOK.push({uid:l,title:DEV_ASS[l]});if(a.vendor_ids){h={};for(k in VENDOR_SPISOK)for(n=0;n<VENDOR_SPISOK[k].length;n++)l=VENDOR_SPISOK[k][n],0<=a.vendor_ids.indexOf(l.uid)&&(void 0==h[k]&&(h[k]=[]),h[k].push(l));VENDOR_SPISOK=h}if(a.model_ids){h={};for(k in MODEL_SPISOK)for(n=0;n<MODEL_SPISOK[k].length;n++)l=
MODEL_SPISOK[k][n],0<=a.model_ids.indexOf(l.uid)&&(h[k]||(h[k]=[]),h[k].push(l));MODEL_SPISOK=h}0<a.add&&(a.device_funcAdd=function(){q=_dialog({width:300,head:"Добавление нoвого устройства",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="daname"></table>',submit:b});$("#daname").focus().keyEnter(b)},a.vendor_funcAdd=function(){q=_dialog({width:300,head:"Добавление нoвого производителя",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="vaname"></table>',
submit:c});$("#vaname").focus().keyEnter(c)},a.model_funcAdd=function(){q=_dialog({width:300,head:"Добавление нoвой модели",content:'<table class="device-add-tab"><tr><td class="label">Название:<td><input type="text" id="maname"></table>',submit:e,focus:"#model_name"});$("#maname").focus().keyEnter(e)});t._select({width:a.width,block:1,title0:["Устройство не выбрано","Любое устройство"][a.type_no],spisok:DEV_SPISOK,func:function(b){s.val(0);r.val(0)._select("remove");b?d(0):s._select("remove");a.func(m())},
funcAdd:a.device_funcAdd,bottom:3});a.device_id&&d()};
$.fn.zayavExpense=function(a){function b(a){a||(a=[0,"",""]);var c=e+f,d=c+"cat",p=c+"worker",l=c+"zp";u.append('<table id="ptab'+f+'" class="ptab" val="'+f+'"><tr><td><input type="hidden" id="'+d+'" value="'+a[0]+'" /><td class="tddop">'+(a[0]&&ZE_TXT[a[0]]?'<input type="text" class="zetxt" placeholder="описание не указано" tabindex="'+(10*f-1)+'" value="'+a[1]+'" />':"")+(a[0]&&ZE_WORKER[a[0]]?'<input type="hidden" id="'+p+'" value="'+a[1]+'" />':"")+(a[0]&&ZE_ZP[a[0]]?'<input type="hidden" id="'+
l+'" value="'+a[1]+'" />':"")+'<td class="tdsum'+(a[0]?"":" dn")+'"><input type="text" class="zesum" maxlength="6" tabindex="'+10*f+'" value="'+a[2]+'" />руб.</table>');var m=$("#ptab"+f),h=m.find(".tddop"),g=m.find(".zesum");$("#"+d)._select({width:130,disabled:0,title0:"Категория",spisok:ZE_SPISOK,func:function(a){m.find(".tdsum")[(a?"remove":"add")+"Class"]("dn");ZE_TXT[a]?(h.html('<input type="text" class="zetxt" placeholder="описание не указано" tabindex="'+(10*f-11)+'" />'),h.find(".zetxt").focus()):
(ZE_WORKER[a]?(h.html('<input type="hidden" id="'+p+'" />'),$("#"+p)._select({width:240,title0:"Сотрудник не указан",spisok:WORKER_SPISOK,func:function(a){g.focus()}})):ZE_ZP[a]?(h.html('<input type="hidden" id="'+l+'" />'),$("#"+l)._select({width:240,title0:"Запчасть не выбрана",spisok:ZAYAV.zp_avai,func:function(a){g.focus()}})):h.html(""),g.focus());g.val(1==a?ZAYAV.worker_zp:"");a&&!m.next().hasClass("ptab")&&b()}});a[0]&&ZE_WORKER[a[0]]&&$("#"+p)._select({width:240,disabled:0,title0:"Сотрудник",
spisok:WORKER_SPISOK,func:function(a){g.focus()}});a[0]&&ZE_ZP[a[0]]&&$("#"+l)._select({width:240,title0:"Запчасть не выбрана",spisok:ZAYAV.zp_avai,func:function(a){g.focus()}});f++}var c=$(this),e=c.attr("id"),f=1,d;if("string"==typeof a&&"get"==a){a=c.find(".ptab");c=[];for(d=0;d<a.length;d++){var g=a.eq(d),p=e+g.attr("val"),m=$("#"+p+"cat").val(),l=g.find(".zesum").val(),h="";if(0!=m){if(!_cena(l)&&"0"!=l)return"sum_error";ZE_TXT[m]?h=g.find(".zetxt").val():ZE_WORKER[m]?h=$("#"+p+"worker").val():
ZE_ZP[m]&&(h=$("#"+p+"zp").val());c.push(m+":"+h+":"+l)}}return c.join()}c.html('<div id="_ze-edit"></div>');var u=c.find("#_ze-edit");if("object"==typeof a)for(d=0;d<a.length;d++)b(a[d]);b();return c};
$.fn.cartridge=function(a){function b(a){e.append('<input type="hidden" class="icar" id="car'+f+'" '+(a?'value="'+a+'" ':"")+"/>");$("#car"+f)._select({width:170,bottom:4,title0:"картридж не выбран",write:1,spisok:CARTRIDGE_SPISOK,func:c,funcAdd:function(a){cartridgeNew(a,c)}})}function c(a){if(a){a=e.find(".icar");for(d=0;d<a.length;d++)if(0==a.eq(d).val())return;f++;b()}}var e=$(this);e.attr("id");var f=1,d;if("string"==typeof a&&"get"==a){a=e.find(".icar");var g=[],p;for(d=0;d<a.length;d++)p=a.eq(d).val(),
0!=p&&g.push(p);return g.join()}if("object"==typeof a)for(g=0;g<a.length;g++)b(a[g]),f++;b()};
$(document).keydown(function(a){function b(){scannerWord="";scannerTime=0;scannerTimer&&clearTimeout(scannerTimer);scannerTimer=void 0;scannerDialogShow=!1}if(!scannerDialogShow)if(13==a.keyCode){var c=(new Date).getTime()-scannerTime;if(5<scannerWord.length&&300>c){scannerDialogShow=!0;scannerTimer=setTimeout(b,500);scannerDialog=_dialog({head:"Сканер штрих-кода",width:250,content:"Получен код: <b>"+scannerWord+"</b>",butSubmit:"Поиск"});var e={op:"scanner_word",word:scannerWord};scannerDialog.process();
$.post(AJAX_WS,e,function(b){if(b.success)if("input"==a.target.localName)scannerDialog.close();else if("zayav"==_cookie("p")&&"add"==_cookie("d"))$("#"+(b.imei?"imei":"serial")).val(e.word),scannerDialog.close();else if(b.zayav_id)document.location.href=URL+"&p=zayav&d=info&id="+b.zayav_id;else{var c="client"==_cookie("p")&&"info"==_cookie("d")?_cookie("id"):0;document.location.href=URL+"&p=zayav&d=add&"+(b.imei?"imei":"serial")+"="+e.word+(c?"&back=client&id="+c:"")}else scannerDialog.abort()},"json")}}else scannerDialog&&
(scannerDialog.close(),scannerDialog=void 0),scannerTimer&&clearTimeout(scannerTimer),scannerTimer=setTimeout(b,500),scannerWord||(scannerTime=(new Date).getTime()),scannerWord+=charSpisok[a.keyCode]||""}).on("mouseenter",".zayav_link",function(a){var b=$(this),c=b.find(".tooltip");c.hasClass("empty")&&(b={op:"zayav_tooltip",id:b.attr("val")},$.post(AJAX_WS,b,function(b){90>a.clientY&&c.css("top","12px");c.html(b.html).removeClass("empty")},"json"))}).on("keyup","#zayavNomer",function(){var a=$(this);
if(!a.hasClass("_busy")){a.next(".zayavNomerTab").remove().end().addClass("_busy");var b={op:"zayav_nomer_info",nomer:a.val()};$.post(AJAX_WS,b,function(b){a.removeClass("_busy");b.success&&a.after(b.html)},"json")}}).on("click",".day-finish-link",function(a){a.stopPropagation();var b=$(this),c=b.hasClass("no-save")?0:1;if(!b.hasClass("_busy")){var e=_dialog({top:40,width:480,head:"Календарь ремонтов",load:1,butSubmit:""}),f={op:"zayav_day_finish",day:$("#day_finish").val(),zayav_spisok:$("#zayav").length};
$.post(AJAX_WS,f,function(a){a.success?e.content.html(a.html):e.loadError()},"json");$(document).off("click","#zayav-finish-calendar td.d:not(.old),#fc-cancel,.fc-old-sel").on("click","#zayav-finish-calendar td.d:not(.old),#fc-cancel,.fc-old-sel",function(){b.hasClass("_busy")||(e.close(),b.addClass("_busy"),f={op:"zayav_day_finish_save",day:$(this).attr("val"),zayav_id:window.ZAYAV?ZAYAV.id:0,save:c},$.post(AJAX_WS,f,function(a){b.removeClass("_busy");a.success&&(b.prev("input").val(f.day),b.find("span").html(a.data),
$("#zayav").length&&zayavSpisok())},"json"))})}}).on("click","#zayav-finish-calendar .ch",function(){if(!$("#fc-head").hasClass("_busy")){$("#fc-head").addClass("_busy");var a={op:"zayav_day_finish_next",mon:$(this).attr("val"),day:$("#day_finish").val(),zayav_spisok:$("#zayav").length};$.post(AJAX_WS,a,function(a){a.success?$("#zayav-finish-calendar").after(a.html).remove():$("#fc-head").removeClass("_busy")},"json")}}).on("click","#zayav-add",function(){function a(){location.href=URL+"&p=zayav&d=add&back="+
c}var b=$(this),c=b.attr("val");if(b.hasClass("cartridge")){var e=_dialog({top:30,width:300,head:"Новая заявка",content:'<div id="zayav-add-tab"><div class="unit" id="go-device">Приём в ремонт<br />оборудования</div><div class="unit" id="cartridge-add">Заправка, восстановление<br />картриджей</div></div>',butSubmit:""});$("#go-device").click(a);$("#cartridge-add").click(function(){e.close();zayavCartridgeAdd()})}else a()}).on("click","#zayav ._next",function(){if(!$(this).hasClass("busy")){var a=
$(this),b=zayavFilter();b.page=$(this).attr("val");a.addClass("busy");$.post(AJAX_WS,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click",".zayav_unit",function(){_cookie("zback_scroll",VK_SCROLL);var a=$(this),b=a.hasClass("cart")?"&from=cartridge":"";location.href=URL+"&p=zayav&d=info&id="+a.attr("val")+b}).on("mouseenter",".zayav_unit",function(){var a=$(this),b=a.find(".note").html();b&&a.vkHint({width:150,msg:b,ugol:"left",top:10,left:a.width()+43,show:1,
indent:5,delayShow:500})}).on("click","#zayav #sort_radio div",zayavSpisok).on("click","#zayav #zpzakaz_radio div",zayavSpisok).on("click","#zayav .clear",function(){$("#find")._search("clear");$("#sort")._radio(1);$("#desc")._check(0);$("#status").rightLink(0);$("#day_finish").val("0000-00-00");$(".day-finish-link span").html("не указан");$("#diagnost")._check(0);$("#diff")._check(0);$("#zpzakaz")._radio(0);$("#executer")._select(0);$("#dev").device({width:155,type_no:1,device_ids:Z.device_ids,vendor_ids:Z.vendor_ids,
model_ids:Z.model_ids,func:zayavSpisok});$("#device_place")._select(0);zayavSpisok()}).on("click","#zayav-cartridge ._next",function(){if(!$(this).hasClass("busy")){var a=$(this),b=cartridgeFilter();b.page=$(this).attr("val");a.addClass("busy");$.post(AJAX_WS,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click","#zayav-cartridge .clear",function(){$("#sort")._radio(1);$("#desc")._check(0);$("#status").rightLink(0);$("#paytype")._radio(0);$("#noschet")._check(0);
cartridgeSpisok()}).on("click","#zayav-info .zedit",function(){var a=_dialog({width:420,top:30,head:"Заявка №"+ZAYAV.nomer+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label r">Клиент:\t\t<td><input type="hidden" id="client_id" value="'+ZAYAV.client_id+'"><tr><td class="label r top">Устройство:<td><table><td id="dev"><td id="device_image"></table><tr><td><td>'+ZAYAV.images+'<tr><td class="label r">IMEI:\t\t  <td><input type="text" id="imei" maxlength="20" value="'+ZAYAV.imei+
'"><tr><td class="label r">Серийный номер:<td><input type="text" id="serial" maxlength="30" value="'+ZAYAV.serial+'"><tr><td class="label r">Цвет:<td><input type="hidden" id="color_id" value="'+ZAYAV.color_id+'" /><span class="color_dop dn"><tt>-</tt><input TYPE="hidden" id="color_dop" value="'+ZAYAV.color_dop+'" /></span><tr class="tr_equip'+(ZAYAV.equip?"":" dn")+'"><td class="label r top">Комплектация:<td class="equip_spisok">'+ZAYAV.equip+'<tr><td class="label r">Диагностика:<td><input TYPE="hidden" id="diagnost" value="'+
ZAYAV.diagnost+'" /><tr><td class="label">Стоимость ремонта:<td><input type="text" class="money" id="pre_cost" maxlength="11" value="'+(ZAYAV.pre_cost?ZAYAV.pre_cost:"")+'" /> руб.</table>',butSubmit:"Сохранить",submit:function(){var b,c={op:"zayav_edit",zayav_id:ZAYAV.id,client_id:$("#client_id").val(),device:$("#dev_device").val(),vendor:$("#dev_vendor").val(),model:$("#dev_model").val(),imei:$.trim($("#imei").val()),serial:$.trim($("#serial").val()),color_id:$("#color_id").val(),color_dop:$("#color_dop").val(),
equip:"",diagnost:$("#diagnost").val(),pre_cost:$("#pre_cost").val()};if(!$(".tr_equip").hasClass("dn")){for(var e=$(".equip_spisok input"),f=[],d=0;d<e.length;d++){var g=e.eq(d);1==g.val()&&f.push(g.attr("id").split("_")[1])}c.equip=f.join()}0==c.deivce?b="Не выбрано устройство":0==c.client_id?b="Не выбран клиент":c.pre_cost&&!REGEXP_NUMERIC.test(c.pre_cost)?(b="Некорректно указана предварительная стоимость",$("#pre_cost").focus()):(a.process(),$.post(AJAX_WS,c,function(b){b.success?(a.close(),_msg("Данные изменены!"),
document.location.reload()):a.abort()},"json"));b&&a.bottom.vkHint({msg:'<SPAN class="red">'+b+"</SPAN>",top:-47,left:107,show:1,remove:1})}});$("#client_id").clientSel({width:267});$("#client_id_select").vkHint({msg:"Если изменяется клиент, то начисления и платежи заявки применяются на нового клиента.",width:200,top:-83,left:-2,delayShow:1500});$("#dev").device({width:190,device_id:ZAYAV.device,vendor_id:ZAYAV.vendor,model_id:ZAYAV.model,add:1,func:zayavDevSelect});modelImageGet();imageSortable();
colorSelDop(ZAYAV.color_id);$("#diagnost")._check()}).on("click","#zayav-info .schet-add",function(){function a(){for(var c="<tr><th>№<th>Наименование товара<th>Кол-во<th>Цена<th>Сумма<th>",e=0,l=0;l<f.length;l++)var h=f[l],g=h.cost*h.count,c=c+('<tr><td class="td-n">'+(l+1)+'<td class="td-name">'+h.name+'<td class="td-count">'+h.count+'<td class="td-cost">'+h.cost+'<td class="td-sum">'+g+"<td>"+(h.del?'<div val="'+l+'" class="img_del pole-del'+_tooltip("Удалить",-29)+"</div>":"")),e=e+g;d=l+1;c+=
'<tr><td colspan="6" class="_next" id="pole-add">Добавить позицию для счёта';$("#schet-tab").html(c);$("#itog").html("Всего наименований "+l+", на сумму "+e+" руб.");$("#pole-add").click(b);$(".pole-del").click(function(){f.splice(_num($(this).attr("val")),1);a()})}function b(){var a=$(this),b='<tr id="tr-add"><td class="td-n">'+d+'<td class="td-name"><input type="text" id="name" /><td class="td-count"><input type="text" id="count" value="1" /><td class="td-cost"><input type="text" id="cost" /><td><div class="vkButton"><button>OK</button></div><td><div class="img_del'+
_tooltip("Отменить",-32)+"</div>";a.parent().hide();$("#schet-tab").append(b);$("#name").focus();$("#tr-add .img_del").click(function(){$("#tr-add").remove();a.parent().show()});$("#tr-add .vkButton").click(c)}function c(){var b=$.trim($("#name").val()),c=_num($("#count").val()),d=_num($("#cost").val());b?c?d?(f.push({name:b,count:c,cost:d,del:1}),a()):(e("Некорректное количество"),$("#cost").focus()):(e("Некорректная сумма"),$("#count").focus()):(e("Не указано наименование"),$("#name").focus())}
function e(a){$("#name").vkHint({msg:'<span class="red">'+a+"</span>",remove:1,indent:40,show:1,top:-58,left:404})}$(this);var f,d,g=_dialog({top:20,width:580,head:"Формирование счёта",load:1,butSubmit:"Сформировать",submit:function(){var a={op:"zayav_cartridge_schet_add",zayav_id:ZAYAV.id,spisok:f,date_create:$("#date_create").val(),dop:_num($("#dop").val()),acc:_num($("#acc").val())};a.spisok.length?a.dop?(g.process(),$.post(AJAX_WS,a,function(a){a.success?($("#cart-tab").html(a.cart),$("#schet-spisok").html(a.schet),
$("#money_spisok").html(a.acc),g.close(),_msg("Новый счёт сформирован")):g.abort()},"json")):g.err("Выберите дополнительный документ"):g.err("Не добавлено ни одной позиции")}});$.post(AJAX_WS,{op:"zayav_cartridge_schet_load",zayav_id:ZAYAV.id},function(b){b.success?(f=b.spisok,g.content.html('<div id="schet-add-tab"><table class="_spisok" id="schet-tab"></table><div id="itog"></div><table id="sa-tab"><tr><td class="label r">Дата:<td><input id="date_create" type="hidden" /><tr><td class="label r topi">Приложения:<td><input id="dop" type="hidden" /><tr><td><td><input id="acc" type="hidden" /></table></div>'),
a(),$("#date_create")._calendar({lost:1}),$("#dop")._radio({light:1,spisok:[{uid:1,title:"Накладная"},{uid:2,title:"Акт выполненных работ"}]}),$("#acc")._check({name:"Произвести начисление по счёту"})):g.loadError()},"json")}).on("click","#zayav-info .acc_add",function(){function a(){var a,e={op:"zayav_accrual_add",zayav_id:ZAYAV.id,sum:$("#sum").val(),prim:$("#prim").val(),status:$("#acc_status").val(),remind:$("#acc_remind").val(),remind_txt:$("#reminder_txt").val(),remind_day:$("#reminder_day").val()};
REGEXP_NUMERIC.test(e.sum)?1!=e.remind||e.remind_txt?(b.process(),$.post(AJAX_WS,e,function(a){b.abort();a.success&&(b.close(),_msg("Начисление успешно произведено!"),$("#money_spisok").html(a.html),zayavMoneyUpdate(),a.status&&($("#status").html(a.status.name).css("background-color","#"+a.status.color),$("#status_dtime").html(a.status.dtime)),a.remind&&$("#remind-spisok").html(a.remind))},"json")):(a="Не указан текст напоминания",$("#reminder_txt").focus()):(a="Некорректно указана сумма.",$("#sum").focus());
a&&b.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-48,left:123,indent:40,remove:1,show:1})}var b=_dialog({top:60,width:420,head:"Заявка №"+ZAYAV.nomer+" - Начисление за выполненную работу",content:'<table class="zayav_accrual_add"><tr><td class="label">Сумма: <td><input type="text" id="sum" class="money" maxlength="5" /> руб.<tr><td class="label">Примечание:<em>(не обязательно)</em><td><input type="text" id="prim" maxlength="100" /><tr><td class="label">Статус заявки: <td><input type="hidden" id="acc_status" value="2" /><tr><td class="label">Добавить напоминание:<td><input type="hidden" id="acc_remind" /></table><table class="zayav_accrual_add remind"><tr><td class="label">Содержание:<td><input type="text" id="reminder_txt" value="Позвонить и сообщить о готовности."><tr><td class="label">Дата:<td><input type="hidden" id="reminder_day"></table>',
submit:a});$("#sum").focus();$("#sum,#prim,#reminder_txt").keyEnter(a);$("#acc_status")._dropdown({spisok:STATUS});$("#acc_remind")._check();$("#acc_remind_check").click(function(a){$(".zayav_accrual_add.remind").toggle()});$("#reminder_day")._calendar()}).on("click","#zayav-info .acc_del",function(){var a={op:"zayav_accrual_del",id:$(this).attr("val")},b=$(this).parent().parent();b.html('<td colspan="4" class="deleting">Удаление...');$.post(AJAX_WS,a,function(c){c.success&&(b.find(".deleting").html('Начисление удалено. <a class="acc_rest" val="'+
a.id+'">Восстановить</a>'),zayavMoneyUpdate())},"json")}).on("click","#zayav-info .acc_rest",function(){var a={op:"zayav_accrual_rest",id:$(this).attr("val")},b=$(this),c=b.parent().parent();b.remove();$.post(AJAX_WS,a,function(a){a.success&&(c.after(a.html).remove(),zayavMoneyUpdate())},"json")}).on("click","#zayav-info .status_place",function(){var a=_dialog({top:30,width:420,head:"Изменение статуса заявки",content:'<div id="zayav-status">'+(1!=ZAYAV.status?'<div class="st c1" val="1">Ожидает выполнения<div class="about">Возобновление работы по заявке.</div></div>':
"")+(2!=ZAYAV.status?'<div class="st c2" val="2">Выполнено<div class="about">Заявка выполнена успешно.<br />Не забудьте расписать расходы по заявке, проверьте начисления.<br />Добавьте напоминание, если необходимо.</div></div>':"")+(3!=ZAYAV.status?'<div class="st c3" val="3">Заявка отменена<div class="about">Отмена заявки по какой-либо причине.</div></div>':"")+'<input type="hidden" id="zs-status" /><table id="zs-tab"><tr><td class="label r topi">Местонахождение устройства:<td><input type="hidden" id="place" value="-1" /><tr id="zs-srok" class="dn"><td class="label r">Срок выполнения:<td><input type="hidden" id="zs-day_finish" value="0000-00-00" /><div class="day-finish-link no-save"><span>не указан</span></div></table></div>',
butSubmit:"Сохранить",submit:function(){var b={op:"zayav_status_place",zayav_id:ZAYAV.id,status:1*$("#zs-status").val(),place:1*$("#place").val(),place_other:$("#place_other").val(),day_finish:$("#zs-day_finish").val()};0<b.dev_place&&(b.place_other="");b.status?-1==b.place||0==b.place&&""==b.place_other?(a.err("Не указано местонахождение устройства"),$("#place_other").focus()):1==b.status&&"0000-00-00"==b.day_finish?a.err("Не указан срок выполнения"):(a.process(),$.post(AJAX_WS,b,function(b){b.success?
(a.close(),_msg("Изменения сохранены."),document.location.reload()):a.abort()},"json")):a.err("Выберите статус заявки")}});zayavPlace(ZAYAV.place_other);$(".st").click(function(){var a=$(this),c=a.attr("val");a.parent().find(".st").hide();a.show();$("#zs-status").val(c);$("#zs-tab").show();1==c&&$("#zs-srok").removeClass("dn")})}).on("click","#zayav-info .cartridge_status",function(){function a(){var a={op:"zayav_cartridge_status",zayav_id:ZAYAV.id,status:_num($("#zs-status").val())};b.process();
$.post(AJAX_WS,a,function(a){a.success?(b.close(),_msg("Изменения сохранены."),document.location.reload()):b.abort()},"json")}var b=_dialog({top:30,width:420,head:"Изменение статуса заявки",content:'<div id="zayav-status">'+(1!=ZAYAV.status?'<div class="st c1" val="1">Ожидает выполнения<div class="about">Возобновление работы по заявке.</div></div>':"")+(2!=ZAYAV.status?'<div class="st c2" val="2">Выполнено<div class="about">Заявка выполнена успешно.<br />Не забудьте расписать расходы по заявке, проверьте начисления.<br />Добавьте напоминание, если необходимо.</div></div>':
"")+(3!=ZAYAV.status?'<div class="st c3" val="3">Заявка отменена<div class="about">Отмена заявки по какой-либо причине.</div></div>':"")+'<input type="hidden" id="zs-status" /></div>',butSubmit:"",submit:a});$(".st").click(function(){var b=$(this).attr("val");$("#zs-status").val(b);a()})}).on("click","#zayav-info .dev_place",function(){var a=_dialog({head:"Изменение местонахождения устройства",content:'<table class="device-add-tab"><tr><td class="label r topi">Местонахождение устройства:<td><input type="hidden" id="place" value="-1" /></table>',
butSubmit:"Сохранить",submit:function(){var b={op:"zayav_device_place",zayav_id:ZAYAV.id,place:1*$("#place").val(),place_other:$("#place_other").val()};0<b.dev_place&&(b.place_other="");-1==b.place||0==b.place&&""==b.place_other?(a.bottom.vkHint({msg:'<span class="red">Не указано местонахождение устройства</SPAN>',top:-47,left:80,indent:50,show:1,remove:1}),$("#place_other").focus()):(a.process(),$.post(AJAX_WS,b,function(b){b.success?(a.close(),_msg("Изменения сохранены."),document.location.reload()):
a.abort()},"json"))}});zayavPlace(ZAYAV.place_other)}).on("click","#zayav-info .zakaz",function(){var a=$(this),b={op:"zayav_zp_zakaz",zayav_id:ZAYAV.id,zp_id:a.parent().parent().attr("val")};$.post(AJAX_WS,b,function(b){b.success&&(a.html("Заказано!").attr("class","zakaz_ok"),_msg(b.msg))},"json")}).on("click","#zayav-info .zakaz_ok",function(){location.href=URL+"&p=zp&menu=3"}).on("click","#zayav-info .zpAdd",function(){var a=_dialog({top:40,width:380,head:"Внесение новой запчасти",content:'<div class="zayav_zp_add"><center>Добавление запчасти к устройству<br /><b>'+
DEV_ASS[ZAYAV.device]+" "+VENDOR_ASS[ZAYAV.vendor]+" "+MODEL_ASS[ZAYAV.model]+'</b>.</center><table style="border-spacing:6px"><tr><td class="label r">Наименование запчасти:<td><input type="hidden" id="name_id" /><tr><td class="label r">Версия:<td><input type="text" id="version" maxlength="30" /><tr><td class="label r">Цвет:<td><input type="hidden" id="color_id" /><tr><td class="label r">Б/у:<td><input type="hidden" id="bu" /></table></div>',submit:function(){var b={op:"zayav_zp_add",zayav_id:ZAYAV.id,
name_id:$("#name_id").val(),version:$("#version").val(),color_id:$("#color_id").val(),bu:$("#bu").val()};0==b.name_id?a.bottom.vkHint({msg:'<SPAN class="red">Не указано наименование запчасти.</SPAN>',top:-47,left:56,show:1,remove:1}):(a.process(),$.post(AJAX_WS,b,function(b){b.success&&(_msg("Внесение запчасти произведено."),a.close(),$("#zpSpisok").html(b.html))},"json"))}});$("#name_id")._select({width:200,title0:"Наименование не выбрано",spisok:ZPNAME_SPISOK});$("#color_id")._select({width:130,
title0:"Цвет не указан",spisok:COLOR_SPISOK});$("#bu")._check()}).on("click","#zayav-info .set",function(){var a=$(this).parent().parent(),b='<center class="zayav_zp_set">Установка запчасти<br />'+a.find("a:first").html()+".<br />"+(0<a.find(".color").length?a.find(".color").html()+".<br />":"")+"<br />Информация об установке также<br />будет добавлена в заметки<br />и в расходы по заявке.</center>",c=_dialog({top:150,width:400,head:"Установка запчасти",content:b,butSubmit:"Установить",submit:function(){var b=
{op:"zayav_zp_set",zp_id:a.attr("val"),zayav_id:ZAYAV.id};c.process();$.post(AJAX_WS,b,function(b){b.success?(zayavMoneyUpdate(),c.close(),_msg("Установка запчасти произведена."),a.parent().html(b.zp_unit),$(".vkComment").after(b.comment).remove()):c.abort()},"json")}})}).on("click",".zayav_kvit",function(){kvitHtml($(this).attr("val"))}).on("click","#zayav-info .zc-edit",function(){var a=_dialog({width:470,head:"Редактирование заявки",content:'<table id="cartridge-add-tab"><tr><td class="label">Клиент:<td><input type="hidden" id="client_id" value="'+
ZAYAV.client_id+'" /><tr><td class="label"><b>Количество картриджей:</b><td><input type="text" id="count" value="'+ZAYAV.cartridge_count+'" /> шт.<tr><td class="label topi">Расчёт:<td><input type="hidden" id="pay_type" value="'+ZAYAV.pay_type+'" /></table>',butSubmit:"Сохранить",submit:function(){var b={op:"zayav_cartridge_edit",zayav_id:ZAYAV.id,client_id:_num($("#client_id").val()),count:_num($("#count").val()),pay_type:_num($("#pay_type").val())};b.client_id?b.count?b.pay_type?(a.process(),$.post(AJAX_WS,
b,function(b){b.success?(a.close(),_msg("Заявка изменена"),document.location.reload()):a.abort()},"json")):a.err("Укажите вид расчёта"):a.err("Не указано количество картриджей"):a.err("Не указан клиент")}});$("#client_id").clientSel({add:1});$("#pay_type")._radio({light:1,spisok:PAY_TYPE})}).on("click","#zayav-info #cart-add",zayavInfoCartridgeAdd).on("click","#zayav-info .cart-edit",function(){function a(){var a=0,b=_num($("#cart_id").val());1==$("#filling").val()&&(a=CARTRIDGE_FILLING[b]);1==$("#restore").val()&&
(a+=CARTRIDGE_RESTORE[b]);1==$("#chip").val()&&(a+=CARTRIDGE_CHIP[b]);$("#cost").val(a)}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),e=b.find(".cart_id").val(),f=b.find(".filling").val(),d=b.find(".restore").val(),g=b.find(".chip").val(),p=b.find(".cost").html(),b=b.find("u").html(),m=_dialog({width:470,top:30,head:"Действия по картриджу",content:'<table id="cart-edit-tab"><tr><td class="label">Картридж:<td><input type="hidden" id="cart_id" value="'+e+'" /><tr><td class="label topi">Действие:<td><input type="hidden" id="filling" value="'+
f+'" /><input type="hidden" id="restore" value="'+d+'" /><input type="hidden" id="chip" value="'+g+'" /><tr><td class="label">Стоимость работ:<td><input type="text" class="money" id="cost" value="'+p+'" /> руб.<tr><td class="label">Примечание:<td><input type="text" id="prim" value="'+b+'" /></table>',butSubmit:"Сохранить",submit:function(){var a={op:"zayav_info_cartridge_edit",id:c,cart_id:_num($("#cart_id").val()),filling:$("#filling").val(),restore:$("#restore").val(),chip:$("#chip").val(),cost:$("#cost").val(),
prim:$("#prim").val()};a.cart_id?(m.process(),$.post(AJAX_WS,a,function(a){a.success?(m.close(),$("#cart-tab").html(a.html),_msg("Изменено.")):m.abort()},"json")):m.err("Не выбран картридж")}});$("#cart_id")._select({write:1,spisok:CARTRIDGE_SPISOK,func:a});$("#filling")._check({name:"Заправка",func:a});$("#restore")._check({name:"Восстановление",func:a});$("#chip")._check({name:"Замена чипа",func:a})}).on("click","#zayav-info .cart-del",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();
var b=a.attr("val"),c=_dialog({head:"Удаление картриджа",content:"<center>Подтвердите удаление картриджа.</center>",butSubmit:"Удалить",submit:function(){var a={op:"zayav_info_cartridge_del",id:b};c.process();$.post(AJAX_WS,a,function(a){a.success?(c.close(),$("#cart-tab").html(a.html),_msg("Удалено.")):c.abort()},"json")}})}).ready(function(){if($("#zayav").length){$("#find").vkHint({msg:"Поиск производится по<br />совпадению в названии<br />модели, imei и серийном<br />номере.",ugol:"right",top:-9,
left:-178,delayShow:800})._search({width:153,focus:1,txt:"Быстрый поиск...",enter:1,func:zayavSpisok}).inp(Z.find);$("#desc")._check(zayavSpisok);$("#status").rightLink(zayavSpisok);$("#diagnost")._check(zayavSpisok);$("#diff")._check(zayavSpisok);WORKER_SPISOK.push({uid:-1,title:"Не назначен",content:"<b>Не назначен</b>"});$("#executer")._select({width:155,title0:"не указан",spisok:WORKER_SPISOK,func:zayavSpisok});$("#dev").device({width:155,type_no:1,device_id:Z.device_id,vendor_id:Z.vendor_id,
model_id:Z.model_id,device_ids:Z.device_ids,vendor_ids:Z.vendor_ids,model_ids:Z.model_ids,func:zayavSpisok});for(var a=0;a<Z.place_other.length;a++){var b=Z.place_other[a];DEVPLACE_SPISOK.push({uid:encodeURI(b),title:b})}DEVPLACE_SPISOK.push({uid:-1,title:"не известно",content:"<B>не известно</B>"});$("#device_place")._select({width:155,title0:"Любое местонахождение",spisok:DEVPLACE_SPISOK,func:zayavSpisok});Z.cookie_id&&(VK.callMethod("scrollWindow",_cookie("zback_scroll")),$("#u"+Z.cookie_id).css("opacity",
0.1).delay(400).animate({opacity:1},700));zayavFilter()}$("#zayavAdd").length&&($("#client_id").clientSel({add:1}),$("#dev").device({width:190,add:1,device_ids:WS_DEVS,func:zayavDevSelect}),zayavPlace(),colorSelDop(0),$("#comm").autosize(),$(".vkCancel").click(function(){location.href=URL+"&p="+$(this).attr("val")}),$(".vkButton").click(function(){if(!$(this).hasClass("busy")){var a={op:"zayav_add",client_id:$("#client_id").val(),device:$("#dev_device").val(),vendor:$("#dev_vendor").val(),model:$("#dev_model").val(),
equip:"",place:$("#place").val(),place_other:$("#place_other").val(),imei:$("#imei").val(),serial:$("#serial").val(),color:$("#color_id").val(),color_dop:$("#color_dop").val(),diagnost:$("#diagnost").val(),comm:$("#comm").val(),pre_cost:$("#pre_cost").val(),day_finish:$("#day_finish").val()};if(!$(".tr_equip").hasClass("dn")){for(var b=$(".equip_spisok input"),f=[],d=0;d<b.length;d++){var g=b.eq(d);1==g.val()&&f.push(g.attr("id").split("_")[1])}a.equip=f.join()}b="";0==a.client_id?b="Не выбран клиент":
0==a.device?b="Не выбрано устройство":"-1"==a.place||0==a.place&&!a.place_other?b="Не указано местонахождение устройства":!a.pre_cost||REGEXP_NUMERIC.test(a.pre_cost)&&0!=a.pre_cost?"0000-00-00"==a.day_finish?b="Не указан срок выполнения ремонта":(0<a.place&&(a.place_other=""),$(this).addClass("busy"),$.post(AJAX_WS,a,function(a){location.href=URL+"&p=zayav&d=info&id="+a.id},"json")):(b="Некорректно указана предварительная стоимость",$("#pre_cost").focus());b&&$(this).vkHint({msg:'<SPAN class="red">'+
b+"</SPAN>",top:-48,left:201,indent:30,remove:1,show:1})}}));$("#zayav-info").length&&($(".hist").click(function(){$("#dopLinks .sel").removeClass("sel");$(this).addClass("sel");$(".itab").addClass("h")}),$(".info").click(function(){$("#dopLinks .sel").removeClass("sel");$(this).addClass("sel");$(".itab").removeClass("h")}),$(".delete").click(function(){var a=_dialog({top:110,width:250,head:"Удаление заявки",content:"<center>Подтвердите удаление заявки.</center>",butSubmit:"Удалить",submit:function(){var b=
{op:"zayav_delete",zayav_id:ZAYAV.id};a.process();$.post(AJAX_WS,b,function(b){b.success?location.href=URL+"&p=client&d=info&id="+b.client_id:a.abort()},"json")}})}).vkHint({msg:"Заявку можно удалить при отсутствии платежей и начислений. Также удаляются все задачи к этой заявке.",width:150,ugol:"top",top:39,left:457,indent:"right"}),$(".img_print").click(function(){function a(c){b.bottom.vkHint({msg:'<SPAN class="red">Не указана неисправность</SPAN>',top:c?-112:-47,left:c?127:97,indent:50,show:1,
remove:1})}var b=_dialog({width:380,top:30,head:"Заявка №"+ZAYAV.nomer+" - Формирование квитанции",content:'<table class="zayav-print"><tr><td class="label">Дата приёма:<td>'+PRINT.dtime+'<tr><td class="label top">Устройство:<td>'+PRINT.device+'<tr><td class="label">Цвет:<td>'+(PRINT.color?PRINT.color:"<i>не указан</i>")+'<tr><td class="label">IMEI:<td>'+(PRINT.imei?PRINT.imei:"<i>не указан</i>")+'<tr><td class="label">Серийный номер:<td>'+(PRINT.serial?PRINT.serial:"<i>не указан</i>")+'<tr><td class="label">Комплектация:<td>'+
(PRINT.equip?PRINT.equip:"<i>не указана</i>")+'<tr><td class="label">Заказчик:<td><b>'+PRINT.client+'</b><tr><td class="label">Телефон:<td>'+(PRINT.telefon?PRINT.telefon:"<i>не указан</i>")+'<tr><td class="label top">Неисправность:<td><textarea id="defect">'+PRINT.defect+'</textarea><tr><td colspan="2"><a id="preview"><span>Предварительный просмотр квитанции</span></a></table>',butSubmit:"Сохранить квитанцию",submit:function(){var f={op:"zayav_kvit",zayav_id:ZAYAV.id,defect:$.trim($("#defect").val()),
active:1};f.defect?(b.process(),$.post(AJAX_WS,f,function(a){a.success?(b.close(),_msg("Квитанция сохранена"),$("#kvit_spisok").html(a.html)):b.abort()},"json")):a()}});$("#defect").focus().autosize();$("#preview").click(function(){var b=$(this),e={op:"zayav_kvit",zayav_id:ZAYAV.id,defect:$.trim($("#defect").val())};b.hasClass("_busy")||(e.defect?(b.addClass("_busy"),$.post(AJAX_WS,e,function(a){b.removeClass("_busy");a.success&&kvitHtml(a.id)},"json")):a(1))})}),$("#executer_id")._dropdown({title0:"не указан",
spisok:WORKER_SPISOK,func:function(a){var b=$("#executer_td");a={op:"zayav_executer_change",zayav_id:ZAYAV.id,executer_id:a};b.addClass("_busy");$.post(AJAX_WS,a,function(a){b.removeClass("_busy");a.success&&_msg("Исполнитель изменён")},"json")}}),$("#executer_id_dropdown").vkHint({msg:"Сотрудник, который назначен на выполнение данной заявки.",delayShow:1E3,width:150,top:-79,left:-50}),$("#ze-edit").click(function(){var a=_dialog({top:30,width:510,head:"Изменение расходов заявки",content:'<table class="ze-edit-tab"><tr><td class="label">Заявка: <td><b>№'+
ZAYAV.nomer+'</b><tr><td class="label">Расходы:<td><tr><td colspan="2" id="zes"></table>',butSubmit:"Сохранить",submit:function(){var b={op:"zayav_expense_edit",zayav_id:ZAYAV.id,expense:$("#zes").zayavExpense("get")};"sum_error"==b.expense?a.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма</SPAN>',top:-47,left:167,indent:40,show:1,remove:1}):(a.process(),$.post(AJAX_WS,b,function(b){b.success?(zayavMoneyUpdate(),a.close(),_msg("Сохранено.")):a.abort()},"json"))}});$("#zes").zayavExpense(ZAYAV.expense)}),
$("#diagnost-ready").click(function(){var a=_dialog({width:450,head:"Внесение результатов диагностики",content:'<div class="_info">После внесения результатов диагностики к заявке будет добавлен комментарий. При необходимости можно добавить напоминание.</div><table class="_dialog-tab" id="zayav-diagnost-tab"><tr><td class="label">Заявка:<td><b>№'+ZAYAV.nomer+'</b><tr><td class="label topi">Результаты:<td><textarea id="comm"></textarea><tr><td class="label">Добавить напоминание:<td><input type="hidden" id="diagnost-remind" /><tr class="remind-tr"><td class="label">Содержание:<td><input type="text" id="remind-txt" value="Сообщить результаты диагностики"><tr class="remind-tr"><td class="label">Дата:<td><input type="hidden" id="remind-day"></table>',
submit:function(){var b={op:"zayav_diagnost",zayav_id:ZAYAV.id,comm:$("#comm").val(),remind:_num($("#diagnost-remind").val()),remind_txt:$("#remind-txt").val(),remind_day:$("#remind-day").val()};b.comm?b.remind&&!b.remind_txt?(a.err("Не указано содержание напоминания"),$("#remind-txt").focus()):(a.process(),$.post(AJAX_WS,b,function(b){b.success?(a.close(),_msg("Результаты диагностики внесены"),document.location.reload()):a.abort()},"json")):(a.err("Не указан текст результата"),$("#comm").focus())}});
$("#comm").autosize().focus();$("#diagnost-remind")._check();$("#diagnost-remind_check").click(function(a){$(".remind-tr").toggle()});$("#remind-day")._calendar()}));$("#zayav-cartridge").length&&($("#sort")._radio(cartridgeSpisok),$("#desc")._check(cartridgeSpisok),$("#status").rightLink(cartridgeSpisok),$("#paytype")._radio(cartridgeSpisok),$("#noschet")._check(cartridgeSpisok))});
